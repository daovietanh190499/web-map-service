<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Map Service</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        .fade-in-left {
            animation: fadeInLeft 0.3s ease-out;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.hidden {
            transform: translateX(-100%);
        }
        #timeline {
            transition: left 0.3s ease-in-out;
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="map" class="absolute inset-0 z-10"></div>

    <div id="edit-map" class="absolute top-4 right-4 w-1/3 h-1/3 bg-white bg-opacity-90 rounded-lg shadow-md hidden"></div>

    <div id="map-controls" class="absolute bottom-48 right-4 flex flex-col bg-transparent z-40">
        <div id="zoom-in" class="w-10 h-10 bg-white border-2 border-gray-300 rounded mb-1 flex items-center justify-center cursor-pointer hover:bg-gray-100"><i class="fas fa-plus"></i></div>
        <div id="zoom-out" class="w-10 h-10 bg-white border-2 border-gray-300 rounded mb-1 flex items-center justify-center cursor-pointer hover:bg-gray-100"><i class="fas fa-minus"></i></div>
        <div id="layer-select" class="w-10 h-10 bg-white border-2 border-gray-300 rounded flex items-center justify-center cursor-pointer hover:bg-gray-100"><i class="fas fa-layer-group"></i></div>
    </div>

    <div id="layer-menu" class="absolute bottom-64 right-4 bg-white border-2 border-gray-300 rounded p-4 hidden z-50">
        <h3 class="font-bold mb-2">Base Layers</h3>
        <label class="block mb-1">
            <input type="radio" name="baseLayer" value="osm" checked> OpenStreetMap
        </label>
        <label class="block mb-1">
            <input type="radio" name="baseLayer" value="satellite"> Satellite
        </label>
        <h3 class="font-bold mt-4 mb-2">Overlay Layers</h3>
        <label class="block">
            <input type="checkbox" name="overlayLayer" value="markers"> Markers
        </label>
    </div>

    <!-- <div id="timeline" class="absolute bottom-4 left-[370px] right-4 h-40 bg-white bg-opacity-90 rounded-lg shadow-md z-40 transition-all duration-300"></div>

    <div id="context-menu" class="hidden absolute bg-white border border-gray-300 shadow-md z-50">
        <ul class="list-none m-0 p-0">
            <li id="geolocation" class="px-4 py-2 cursor-pointer hover:bg-gray-100"></li>
            <li id="upload-image" class="px-4 py-2 cursor-pointer hover:bg-gray-100">Upload Image</li>
        </ul>
    </div> -->

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var map = L.map('map', {
                zoomControl: false,
                contextmenu: false
            }).setView([21.148023790045897, 105.62239681777376], 13);

            var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            var ownLayer = L.tileLayer('api/images/jp2/tiles/{z}/{x}/{y}.png/', {
                maxZoom: 18,
                attribution: 'JP2 Layer'
            });

            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            var markersLayer = L.layerGroup();

            osmLayer.addTo(map);
            map.addLayer(ownLayer);

            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', function() {
                map.zoomIn();
            });

            document.getElementById('zoom-out').addEventListener('click', function() {
                map.zoomOut();
            });

            // Layer menu
            var layerMenu = document.getElementById('layer-menu');
            var layerSelectButton = document.getElementById('layer-select');

            layerSelectButton.addEventListener('click', function() {
                layerMenu.style.display = layerMenu.style.display === 'none' ? 'block' : 'none';
            });

            document.querySelectorAll('input[name="baseLayer"]').forEach(function(input) {
                input.addEventListener('change', function(e) {
                    if (e.target.value === 'osm') {
                        map.removeLayer(satelliteLayer);
                        map.addLayer(osmLayer);
                    } else if (e.target.value === 'satellite') {
                        map.removeLayer(osmLayer);
                        map.addLayer(satelliteLayer);
                    }
                });
            });

            document.querySelector('input[name="overlayLayer"]').addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.addLayer(markersLayer);
                } else {
                    map.removeLayer(markersLayer);
                }
            });

            // Context menu
            map.on('contextmenu', function(e) {
                clickedLatLng = e.latlng;
                var containerPoint = map.latLngToContainerPoint(e.latlng);
                var x = containerPoint.x;
                var y = containerPoint.y;

                contextMenu.style.display = 'block';
                contextMenu.style.left = x + 'px';
                contextMenu.style.top = y + 'px';

                geolocationItem.textContent = `Lat: ${e.latlng.lat.toFixed(6)}, Lng: ${e.latlng.lng.toFixed(6)}`;

                e.originalEvent.preventDefault();
            });

            map.on('click', function() {
                contextMenu.style.display = 'none';
            });

            uploadImageItem.addEventListener('click', function() {
                if (clickedLatLng) {
                    map.setView(clickedLatLng);

                    var targetScale = 500 / 100000;
                    var targetZoom = Math.round(Math.log2(40075016.686 * Math.abs(Math.cos(clickedLatLng.lat * Math.PI/180)) / (256 * targetScale)));

                    map.setZoom(targetZoom);

                    // Show sidebar with animation
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('fade-in-left');

                    // Add pin marker at clicked location
                    if (uploadMarker) {
                        map.removeLayer(uploadMarker);
                    }
                    uploadMarker = L.marker(clickedLatLng).addTo(map);

                    // Adjust timeline
                    timeline.classList.remove('left-4');
                    timeline.classList.add('left-[370px]');

                }
                contextMenu.style.display = 'none';
            });

            // Toggle sidebar
            document.addEventListener('click', function(event) {
                var isClickInsideSidebar = sidebar.contains(event.target);
                var isClickOnUploadItem = uploadImageItem.contains(event.target);
                var isClickOnSearchInput = event.target.id === 'search-input';
                if (!isClickInsideSidebar && !isClickOnUploadItem && !isClickOnSearchInput && !sidebar.classList.contains('hidden')) {
                    sidebar.classList.add('hidden');
                    // Remove the upload marker when closing sidebar
                    if (uploadMarker) {
                        map.removeLayer(uploadMarker);
                        uploadMarker = null;
                    }
                    // Adjust timeline
                    timeline.classList.add('left-4');
                    timeline.classList.remove('left-[370px]')
                }
            });

            // Handle form submission
            uploadForm.addEventListener('submit', function(event) {
                event.preventDefault();
                // Here you would typically send the form data to your server
                console.log('Form submitted:', new FormData(uploadForm));
                // For demonstration, we'll just log the form data and close the sidebar
                sidebar.classList.add('hidden');
                // Reset the form
                uploadForm.reset();
                // Remove the upload marker
                if (uploadMarker) {
                    map.removeLayer(uploadMarker);
                    uploadMarker = null;
                }
                // Adjust timeline
                timeline.classList.add('left-4');
                timeline.classList.remove('left-[370px]')
            });

            // Close layer menu when clicking outside
            document.addEventListener('click', function(event) {
                var isClickInside = layerMenu.contains(event.target) || layerSelectButton.contains(event.target);
                if (!isClickInside) {
                    layerMenu.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>