<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Map Service</title>
    <link href="static/css/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/leaflet.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/css/leaflet-layer-tree-control.css" />
    <script src="static/js/tailwind.js"></script>
    <link rel="stylesheet" href="static/css/easy-button.css">
    <link rel="stylesheet" href="static/css/Control.FullScreen.css">
    <script src="static/js/leaflet.js"></script>
    <script src="static/js/leaflet.draw.js"></script>
    <link rel="stylesheet" href="static/css/leaflet.draw.css">
    </script>
    <script src="static/js/leaflet-layer-tree-control.js"></script>
    <script src="static/js/leaflet-layer-tree-control-wfs-zoom.js"></script>
    <script src="static/js/easy-button.js"></script>
    <script src="static/js/jquery.js"></script>
    <script src="static/js/togeojson.js"></script>
    <script src="static/js/leaflet.filelayer.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/leaflet.measure.css" />
    <script type="text/javascript" src="static/js/leaflet.measure.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/leaflet.mouse-position.css" />
    <script type="text/javascript" src="static/js/leaflet.mouse-position.js"></script>
    <link rel="stylesheet" type="text/css" href="static/css/leaflet.scalebar.css" />
    <script type="text/javascript" src="static/js/leaflet.scalebar.js"></script>
    <script src="static/js/Control.FullScreen.js"></script>
    <script src="static/js/vue.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.17/dist/esri-leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet-renderers@3.0.1/dist/esri-leaflet-renderers.js"></script>
    <script src="https://unpkg.com/esri-leaflet-vector@4.3.0/dist/esri-leaflet-vector.js" crossorigin=""></script>

    <style>
        @keyframes fadeInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fade-in-left {
            animation: fadeInLeft 0.3s ease-out;
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        #sidebar.hidden {
            transform: translateX(-100%);
        }

        #search-sidebar {
            transition: transform 0.3s ease-in-out;
            height: 100vh;
            width: 360px;
        }

        #search-sidebar.hidden {
            transform: translateX(-100%);
        }

        .filter-section {
            border-bottom: 1px solid #e2e8f0;
        }

        .filter-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0;
        }

        .filter-content.expanded {
            max-height: 500px;
            /* Adjust based on content */
            padding: 1rem;
        }

        .filter-header {
            cursor: pointer;
            padding: 1rem;
            user-select: none;
        }

        .filter-header i {
            transition: transform 0.3s ease;
        }

        .filter-header.expanded i {
            transform: rotate(180deg);
        }

        .search-results-container {
            height: calc(100vh - 120px);
            /* Adjust based on header height */
            overflow-y: auto;
        }

        #app-container {
            display: flex;
        }

        #map-container {
            flex-grow: 1;
        }

        #search-sidebar.hidden {
            display: none;
        }

        #app-container.with-sidebar #map-container {
            width: calc(100% - 33.333%);
            /* Adjust for the sidebar width */
        }

        .upload_file_icon {
            background-repeat: no-repeat;
            background-image: url("static/css/images/folder.svg");
            background-position: center center;
            background-color: transparent;
            background-size: 75% 75%;
            width: 100%;
            height: 100%;
        }

        .arcgis-service {
            background-repeat: no-repeat;
            background-image: url("static/css/images/arcgis_service.webp");
            background-position: center center;
            background-color: transparent;
            background-size: 75% 75%;
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0
        }

        .arcgis-feature {
            background-repeat: no-repeat;
            background-image: url("static/css/images/arcgis_service.webp");
            background-position: center center;
            background-color: transparent;
            background-size: 75% 75%;
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0
        }

        /* Feature Tooltip Styles */
        .feature-tooltip {
            background: white;
            border: 2px solid #3388ff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            max-width: 600px;
            min-width: 450px;
        }

        .feature-tooltip .tooltip-header {
            background: #3388ff;
            color: white;
            padding: 10px 15px;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feature-tooltip .tooltip-content {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .feature-tooltip .metadata-section {
            margin-bottom: 15px;
        }

        .feature-tooltip .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .feature-tooltip .metadata-grid .metadata-item:nth-child(odd):last-child {
            grid-column: 1 / -1;
        }

        @media (max-width: 600px) {
            .feature-tooltip .metadata-grid {
                grid-template-columns: 1fr;
            }
        }

        .feature-tooltip .metadata-item {
            display: flex;
            flex-direction: column;
        }

        .feature-tooltip .metadata-item label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .feature-tooltip .metadata-item input,
        .feature-tooltip .metadata-item textarea {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .feature-tooltip .attachments-section {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .feature-tooltip .attachment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .feature-tooltip .attachment-actions {
            display: flex;
            gap: 5px;
        }

        .feature-tooltip .tooltip-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .feature-tooltip .btn {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }

        .feature-tooltip .btn-primary {
            background: #3388ff;
            color: white;
        }

        .feature-tooltip .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .feature-tooltip .btn-danger {
            background: #dc3545;
            color: white;
        }

        .feature-tooltip .btn-success {
            background: #28a745;
            color: white;
        }

        .feature-tooltip .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .feature-tooltip .error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Gallery Styles */
        .attachments-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .attachment-gallery-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .attachment-gallery-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .attachment-gallery-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .attachment-gallery-item img:hover {
            opacity: 0.8;
        }

        .attachment-gallery-item video {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .attachment-gallery-item audio {
            width: 100%;
        }

        .attachment-gallery-item .file-icon {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            border-radius: 4px;
        }

        .attachment-gallery-item .file-icon i {
            font-size: 2em;
            color: #6c757d;
        }

        /* Media Thumbnail Styles */
        .media-thumbnail {
            position: relative;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            height: 80px;
            background: #f8f9fa;
        }

        .media-thumbnail img,
        .media-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .media-thumbnail:hover img,
        .media-thumbnail:hover video {
            transform: scale(1.05);
        }

        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-thumbnail:hover .media-overlay {
            opacity: 1;
        }

        .media-overlay i {
            color: white;
            font-size: 1.5em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .audio-thumbnail {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .audio-thumbnail i {
            font-size: 2em;
        }

        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Preview Modal Styles */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .preview-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .preview-modal-close:hover {
            color: #333;
        }



        /* Success Message Styles */
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="h-screen overflow-hidden">
    <div class="w-100 h-screen overflow-hidden" id="app">
        <div id="app-container" class="flex h-full">
            <!-- Sidebar -->
            <div id="search-sidebar" class="w-1/3 h-full bg-white shadow-lg z-50 flex-shrink-0" v-if="openSideBar || showMenu">
                <div class="h-full flex flex-col">

                    <!-- Header -->
                    <div class="p-4 border-b">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold">${ showMenu ? 'Layer Menu' : showFeatureSearch ? 'Feature Search' : 'Search Layers' }</h2>
                            <div class="flex items-center gap-2">
                                <button v-if="!showMenu && !showFeatureSearch" id="toggle-filters" class="text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-filter"></i>
                                </button>
                                <button id="close-search" class="text-gray-500 hover:text-gray-700" @click="closeSideBar">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible Filters -->
                    <div id="filters-container" class="hidden">
                        <form id="search-form">
                            <div class="filter-section">
                                <div class="filter-header" data-target="date-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold">Date Range</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div id="date-filter" class="filter-content">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm">Start Date</label>
                                            <input type="datetime-local" name="start_date" v-model="searchForm.startDate"
                                                class="w-full border rounded p-1">
                                        </div>
                                        <div>
                                            <label class="block text-sm">End Date</label>
                                            <input type="datetime-local" name="end_date" v-model="searchForm.endDate" 
                                                class="w-full border rounded p-1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-section">
                                <div class="filter-header" data-target="resolution-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold">Resolution (meters)</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div id="resolution-filter" class="filter-content">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-sm">Min</label>
                                            <input type="number" step="0.1" name="resolution_min" v-model="searchForm.resolutionMin"
                                                class="w-full border rounded p-1">
                                        </div>
                                        <div>
                                            <label class="block text-sm">Max</label>
                                            <input type="number" step="0.1" name="resolution_max" v-model="searchForm.resolutionMax"
                                                class="w-full border rounded p-1">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="filter-section">
                                <div class="filter-header" data-target="metadata-filter">
                                    <div class="flex justify-between items-center">
                                        <span class="font-semibold">Metadata</span>
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                                <div id="metadata-filter" class="filter-content">
                                    <div class="space-y-2">
                                        <div>
                                            <label class="block text-sm">Topic</label>
                                            <input type="text" name="topic" class="w-full border rounded p-1" v-model="searchForm.topic">
                                        </div>
                                        <div>
                                            <label class="block text-sm">Source</label>
                                            <input type="text" name="source" class="w-full border rounded p-1" v-model="searchForm.source">
                                        </div>
                                        <div>
                                            <label class="block text-sm">Satellite ID</label>
                                            <input type="text" name="satellite_id" class="w-full border rounded p-1" v-model="searchForm.satellite">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4">
                                <button type="submit"
                                    class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                                    Apply Filters
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Feature Search Bar -->
                    <div v-if="showFeatureSearch" class="p-4 border-b">
                        <div class="relative mb-3">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" 
                                   v-model="featureSearchQuery" 
                                   @input="searchFeatureResources"
                                   placeholder="Tìm kiếm feature resources..."
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        
                        <!-- Advanced Search Toggle -->
                        <div class="flex justify-between items-center">
                            <button @click="toggleAdvancedSearch" 
                                    class="text-sm text-blue-600 hover:text-blue-800 flex items-center space-x-1">
                                <i class="fas" :class="showAdvancedSearch ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                <span>${ showAdvancedSearch ? 'Hide' : 'Show' } Advanced Search</span>
                            </button>
                        </div>
                    </div>

                    <!-- Advanced Search Panel -->
                    <div v-if="showFeatureSearch && showAdvancedSearch" class="p-4 border-b bg-gray-50">
                        <div class="space-y-4">
                            <!-- Layer Selection -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Layer for Filtering:</label>
                                <select v-model="selectedFilterLayer" @change="onFilterLayerChange" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Choose a layer...</option>
                                    <option v-for="service in getVisibleServices()" :key="service.id" :value="service.id">
                                        ${ service.name }
                                    </option>
                                </select>
                            </div>

                            <!-- Filter Builder -->
                            <div v-if="selectedFilterLayer && filterFields.length > 0">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="text-sm font-medium text-gray-700">Filter Conditions</h4>
                                    <button @click="addFilterCondition" 
                                            class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                        <i class="fas fa-plus"></i> Add Condition
                                    </button>
                                </div>
                                
                                <div class="space-y-3">
                                    <div v-for="(condition, index) in filterConditions" :key="index" 
                                         class="flex items-center space-x-2 p-3 bg-white rounded border">
                                        <div class="flex-1">
                                            <select v-model="condition.field" 
                                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                                                <option value="">Select field...</option>
                                                <option v-for="field in filterFields" :key="field.name" :value="field.name">
                                                    ${ field.name } (${ field.type })
                                                </option>
                                            </select>
                                        </div>
                                        <div class="w-24">
                                            <select v-model="condition.operator" 
                                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                                                <option value="=">=</option>
                                                <option value="!=">!=</option>
                                                <option value=">">></option>
                                                <option value="<"><</option>
                                                <option value=">=">>=</option>
                                                <option value="<="><=</option>
                                                <option value="LIKE">LIKE</option>
                                                <option value="NOT LIKE">NOT LIKE</option>
                                                <option value="IN">IN</option>
                                                <option value="NOT IN">NOT IN</option>
                                            </select>
                                        </div>
                                        <div class="flex-1">
                                            <input type="text" v-model="condition.value" 
                                                   placeholder="Enter value..."
                                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded">
                                        </div>
                                        <button @click="removeFilterCondition(index)" 
                                                class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-trash text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Apply Filter Button -->
                                <div class="mt-4 flex justify-between items-center">
                                    <button @click="applyAdvancedFilter" 
                                            class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">
                                        <i class="fas fa-filter"></i> Apply Filter
                                    </button>
                                    <button @click="clearAdvancedFilter" 
                                            class="text-gray-500 hover:text-gray-700 text-sm">
                                        <i class="fas fa-times"></i> Clear Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Filters -->
                    <div v-if="!showMenu && !showFeatureSearch" class="p-4 border-b">
                        <h3 class="font-semibold mb-3">Quick Filters</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Name</label>
                                <input type="text" v-model="filterForm.name" 
                                    class="w-full border rounded p-2 text-sm"
                                    placeholder="Filter by name...">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-1">Owner</label>
                                <input type="text" v-model="filterForm.owner" 
                                    class="w-full border rounded p-2 text-sm"
                                    placeholder="Filter by owner...">
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">From Date</label>
                                    <input type="date" v-model="filterForm.dateFrom" 
                                        class="w-full border rounded p-2 text-sm">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">To Date</label>
                                    <input type="date" v-model="filterForm.dateTo" 
                                        class="w-full border rounded p-2 text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Search Results -->
                    <div v-if="!showMenu && !showFeatureSearch" class="search-results-container flex-grow p-4">
                        <div id="search-results" class="space-y-2">
                            <div class="flex justify-center items-center py-4" v-if="searchLoading">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            </div>
                            <div class="text-center text-red-500 py-4" v-if="showSearchError">
                                Error performing search. Please try again.
                            </div>
                            <div class="text-center text-gray-500 py-4" v-if="!searchLoading && !showSearchError && searchResults.features.length === 0">
                                No results found
                            </div>
                            <div class="bg-white border rounded-lg shadow-sm hover:shadow-lg transition-all duration-300 mb-4" v-for="(feature, index) in filterSearchResults()" :key="feature.id">
                                <!-- Header Section -->
                                <div class="flex items-center justify-between p-4 border-b">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-layer-group text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold text-lg text-gray-800">${ feature.title }</h3>
                                            <p class="text-sm text-gray-500">${ feature.type }</p>
                                        </div>
                                    </div>
                                    <div>
                                        <i id="${ feature.id }-action"
                                            class="fas w-8 h-8 text-xl cursor-pointer hover:text-blue-600 transition-colors duration-200"
                                            :class="[{'fa-folder-plus': !isInMenu(feature.id), 'fa-folder-minus': isInMenu(feature.id)}]"
                                            @click="toggleMenuLayer(feature)">
                                        </i>
                                    </div>
                                </div>
                            
                                <!-- Content Section -->
                                <div class="p-4">
                                    <!-- Description -->
                                    <div class="mb-3">
                                        <p class="text-gray-600 text-sm">${ feature.description || 'No description available' }</p>
                                    </div>
                            
                                    <!-- Tags -->
                                    <div class="flex flex-wrap gap-2 mb-3">
                                        <template v-for="tag in feature.tags">
                                            <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">${ tag }</span>
                                        </template>
                                    </div>
                            
                                    <!-- Metadata -->
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p class="text-gray-500">Owner</p>
                                            <p class="font-medium">${ feature.owner }</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-500">Last Modified</p>
                                            <p class="font-medium">${ new Date(feature.modified).toLocaleDateString() }</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-500">Access</p>
                                            <p class="font-medium capitalize">${ feature.access }</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-500">Views</p>
                                            <p class="font-medium">${ feature.numViews }</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Feature Search Results -->
                    <div v-if="showFeatureSearch" class="search-results-container flex-grow p-4">
                        <div v-if="featureSearchLoading" class="flex justify-center items-center py-8">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <span class="ml-2 text-gray-600">Đang tìm kiếm...</span>
                        </div>
                        
                        <div v-else-if="featureSearchResults.length === 0 && featureSearchQuery" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>Không tìm thấy kết quả nào</p>
                        </div>
                        
                        <div v-else-if="featureSearchResults.length === 0" class="text-center py-8 text-gray-500">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>Nhập từ khóa để tìm kiếm feature resources</p>
                        </div>
                        
                        <div v-else class="space-y-4">
                            <!-- Chỉ hiển thị 2 cấp độ: Layer (với tên service) và Resources -->
                            <div v-for="service in featureSearchResults" :key="service.id">
                                <div v-for="layer in service.layers" :key="layer.id" class="border rounded-lg p-4 bg-gray-50 mb-4">
                                    <!-- Layer Level với tên service -->
                                    <div class="flex items-center justify-between mb-3">
                                        <div class="flex items-center space-x-3">
                                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                                <i class="fas fa-layer-group text-green-600"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-medium text-gray-800">${ layer.name }</h4>
                                                <p class="text-xs text-gray-500">Service: ${ layer.serviceName }</p>
                                            </div>
                                        </div>
                                        <span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full">
                                            ${ layer.resources.length } resources
                                        </span>
                                    </div>
                                    
                                    <!-- Resources -->
                                    <div class="space-y-2">
                                        <div v-for="resource in layer.resources" :key="resource.objectid" 
                                             class="flex items-center justify-between p-2 bg-white rounded border hover:bg-blue-50 cursor-pointer transition-colors duration-200"
                                             @click="focusOnResource(service, layer, resource)">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-4 h-4 bg-orange-100 rounded-full flex items-center justify-center">
                                                    <i class="fas fa-map-marker-alt text-orange-600 text-xs"></i>
                                                </div>
                                                <div>
                                                    <span class="text-xs font-medium text-gray-800">${ resource.displayName }</span>
                                                    <p class="text-xs text-gray-500">ID: ${ resource.objectid }</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">
                                                    <i class="fas fa-eye"></i> Focus
                                                </span>
                                                <i class="fas fa-external-link-alt text-xs text-gray-400"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Menu Layers -->
                    <div v-if="showMenu" class="search-results-container flex-grow p-4">
                        <!-- Active Layers Info -->
                        <div v-if="getActiveLayersCount() > 0" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-eye text-blue-600"></i>
                                    <span class="text-sm font-medium text-blue-800">
                                        ${ getActiveLayersCount() } layers active
                                    </span>
                                </div>
                                <button @click="clearAllLayers" 
                                    class="text-xs text-red-600 hover:text-red-800 hover:bg-red-50 px-2 py-1 rounded transition-colors duration-200"
                                    title="Clear all layers">
                                    <i class="fas fa-trash"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div v-if="menuServices.length === 0" class="text-center text-gray-500 py-8">
                            <i class="fas fa-layer-group text-4xl mb-4"></i>
                            <p>No services added to menu yet</p>
                            <p class="text-sm">Search for services and click the folder icon to add them</p>
                        </div>
                        
                        <div v-else class="space-y-4">
                            <div v-for="service in menuServices" :key="service.id" 
                                class="border rounded-lg p-4 hover:shadow-md transition-shadow duration-200">
                                <!-- Service Header -->
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                            <i class="fas fa-server text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="font-medium text-gray-800">${ service.name }</h4>
                                            <p class="text-xs text-gray-500">${ service.owner }</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <button @click="toggleServiceVisibility(service)" 
                                            :class="[service.visible ? 'text-green-600' : 'text-gray-400', 'hover:text-green-800']"
                                            class="p-1 hover:bg-green-50 rounded transition-colors duration-200"
                                            :title="service.visible ? 'Hide all layers' : 'Show all layers'">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button @click="removeServiceFromMenu(service.id)" 
                                            class="p-1 text-red-600 hover:text-red-800 hover:bg-red-50 rounded transition-colors duration-200"
                                            title="Remove service">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Status indicator -->
                                <div v-if="service.visible" class="mb-2">
                                    <div class="flex items-center space-x-1 text-xs text-green-600">
                                        <i class="fas fa-circle"></i>
                                        <span>Layers visible on map</span>
                                    </div>
                                </div>
                                
                                <!-- Service Info -->
                                <div class="text-xs text-gray-500 space-y-1 mb-3">
                                    <p><strong>Modified:</strong> ${ new Date(service.modified).toLocaleDateString() }</p>
                                    <p><strong>Status:</strong> 
                                        <span :class="service.visible ? 'text-green-600' : 'text-gray-500'">
                                            ${ service.visible ? 'All layers visible' : 'All layers hidden' }
                                        </span>
                                    </p>
                                </div>
                                
                                <!-- Sublayers -->
                                <div v-if="service.sublayers && service.sublayers.length > 0" class="border-t pt-3">
                                    <h5 class="text-sm font-medium text-gray-700 mb-2">Layers:</h5>
                                    <div class="space-y-2">
                                        <div v-for="sublayer in service.sublayers" :key="sublayer.id" 
                                            class="flex items-center justify-between p-2 bg-gray-50 rounded">
                                            <div class="flex items-center space-x-2">
                                                <div class="w-4 h-4 bg-gray-200 rounded flex items-center justify-center">
                                                    <i class="fas fa-layer-group text-xs text-gray-600"></i>
                                                </div>
                                                <span class="text-sm text-gray-700">${ sublayer.name }</span>
                                            </div>
                                            <button @click="toggleSublayerVisibility(service, sublayer)" 
                                                :class="[sublayer.visible ? 'text-green-600' : 'text-gray-400', 'hover:text-green-800']"
                                                class="p-1 hover:bg-green-50 rounded transition-colors duration-200"
                                                :title="sublayer.visible ? 'Hide layer' : 'Show layer'">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
        
                </div>
            </div>
            <div id="map-container" class="flex-grow relative" :class="[{'with-sidebar': openSideBar || showMenu || showFeatureSearch}]">
                <div id="map" class="absolute inset-0 z-10"></div>
            </div>
        </div>

        

        <!-- Modal Overlay -->
        <div id="upload-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40" v-if="openModal"></div>
        <div id="upload-modal" v-if="openModal"
            class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl p-8 z-50 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Upload Image</h3>

            <div class="flex flex-col gap-6">
                <div class="flex space-x-4 flex-row">
                    <div class="flex-1 space-y-4 flex-col">
                        <!-- Name Input -->
                        <div class="flex flex-col">
                            <label for="modal-name" class="text-sm font-medium text-gray-700 mb-2">Name:</label>
                            <input type="text" id="modal-name" placeholder="Enter image name" v-model="uploadImage.name"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="flex flex-col">
                            <label for="modal-time" class="text-sm font-medium text-gray-700 mb-2">Time:</label>
                            <input type="datetime-local" id="modal-time" v-model="uploadImage.datetime"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="flex flex-col">
                            <label for="modal-source" class="text-sm font-medium text-gray-700 mb-2">Source:</label>
                            <select id="modal-source" v-model="uploadImage.source"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="commercial">Commercial</option>
                                <option value="exchange">Exchange</option>
                                <option value="opensource">Opensource</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex-1 space-y-4 flex-col">
                        <div class="flex flex-col">
                            <label for="modal-format" class="text-sm font-medium text-gray-700 mb-2">Format:</label>
                            <select id="modal-format" v-model="uploadImage.format"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                                <option value="OPT">OPT</option>
                                <option value="SAR">SAR</option>
                                <option value="UAV">UAV</option>
                                <option value="LIDAR">LIDAR</option>
                            </select>
                        </div>

                        <div class="flex flex-col">
                            <label for="modal-satellite" class="text-sm font-medium text-gray-700 mb-2">Satellite ID:</label>
                            <input type="text" id="modal-satellite" v-model="uploadImage.satellite"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- File Input -->
                        <div class="flex flex-col">
                            <label for="modal-file" class="text-sm font-medium text-gray-700 mb-2">Image File:</label>
                            <input type="file" id="modal-file" v-model="uploadImage.file"
                                class="w-full h-10 px-3 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                </div>

                <div class="flex space-y-4 flex-col">
                    <!-- Progress Bar -->
                    <div class="flex flex-col">
                        <label for="upload-progress" class="text-sm font-medium text-gray-700 mb-2">Upload Progress:</label>
                        <progress id="upload-progress" value="0" max="100" class="w-full h-4" v-model="progressBar"></progress>
                    </div>
                </div>
            </div>

            <!-- Buttons -->
            <div class="mt-8 flex justify-end space-x-4">
                <button id="cancel-modal" @click="closeModal"
                    class="px-5 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    Cancel
                </button>
                <button id="save-modal" @click="submitModal"
                    class="px-5 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    Save
                </button>
            </div>
        </div>

        <!-- <div id="login-modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40" v-if="showLoginButton"></div>
        <div id="login-modal" v-if="showLoginButton"
            class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-2xl p-8 z-50 w-full max-w-lg">
            <h3 class="text-2xl font-bold mb-6 text-gray-900">Login to Arcgis</h3>
            <div class="mt-8 flex justify-end space-x-4">
                <button id="login-button-modal" @click="initiateOAuth()"
                    class="px-5 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
                    Login
                </button>
            </div>
        </div> -->

        <div id="login-modal-overlay" 
            class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-40 transition-opacity duration-300" 
            v-if="showLoginButton">
        </div>

        <div id="login-modal" v-if="showLoginButton"
            class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl z-50 w-full max-w-md overflow-hidden">
            
            <!-- Header with decorative background -->
            <div class="bg-blue-600 h-32 relative overflow-hidden">
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute transform rotate-45 translate-x-1/2 -translate-y-1/2 bg-white w-64 h-64"></div>
                    <div class="absolute transform -rotate-45 -translate-x-1/2 translate-y-1/2 bg-white w-64 h-64"></div>
                </div>
            </div>

            <!-- Logo -->
            <div class="flex justify-center -mt-16">
                <div class="w-32 h-32 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white z-10">
                    <img src="/static/css/images/ArcGIS_logo.png" alt="ArcGIS Logo" class="w-full h-full object-contain">
                </div>
            </div>

            <!-- Content -->
            <div class="px-8 py-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-2 text-center">Welcome to ArcGIS Portal</h3>
                <p class="text-gray-600 mb-6 text-center">Sign in to access your account and explore geographic information systems</p>

                <!-- Login Form -->
                <form @submit.prevent="loginWithCredentials" class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="username" v-model="loginForm.username" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your username">
                    </div>
                    
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="password" v-model="loginForm.password" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="Enter your password">
                    </div>

                    <!-- Login Button -->
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium
                            hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-200
                            transform transition-all duration-200 hover:scale-105
                            flex items-center justify-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        <span>Sign in</span>
                    </button>
                </form>
            </div>

            <!-- Bottom decoration -->
            <div class="h-2 bg-gradient-to-r from-blue-500 via-blue-600 to-blue-700"></div>
        </div>
    </div>
</body>

 <script>
    const { createApp } = Vue

    let app = createApp({
        data() {
            return {
                map: null,
                openSideBar: false,
                searchLoading: false,
                showSearchError: false,
                searchResults: {
                    features: []
                },
                listLayer: [],
                listVectorLayer: {},
                openModal: false,
                progressBar: 0,
                uploadImage: {
                    name: "New Name",
                    datetime: "",
                    source: "opensource",
                    format: "OPT",
                    satellite: "VINASAT1",
                    file: null
                },
                expandFilter: false,
                searchForm: {
                    startDate: null,
                    endDate: null,
                    resolutionMin: 0,
                    resolutionMax: 10000,
                    topic: "",
                    source: "",
                    satellite: ""
                },
                arcgisConfig: {
                    portalUrl: 'https://gissoft.esrivn.net/portal',
                    clientId: 'K0LoN8xkKyozyEmw',
                    redirectUri: 'http://localhost/arcgis-authen',
                    apiUrl: 'https://gissoft.esrivn.net/server/rest/services'
                },
                arcgisToken: localStorage.getItem('arcgis_token'),
                showLoginButton: true,
                loginForm: {
                    username: '',
                    password: ''
                },
                menuServices: [],
                showMenu: false,
                filterForm: {
                    name: '',
                    owner: '',
                    dateFrom: '',
                    dateTo: ''
                },
                // Thêm biến cho feature search sidebar
                showFeatureSearch: false,
                featureSearchQuery: '',
                featureSearchResults: [],
                featureSearchLoading: false,
                featureSearchDebounceTimer: null,
                // Advanced search variables
                showAdvancedSearch: false,
                selectedFilterLayer: '',
                filterFields: [],
                filterConditions: [],
                advancedFilterActive: false,
                layerTreeControl: null,
                currentFeatureTooltip: null,
                currentFeatureData: null,
                layerBuilders: {
                    OSM: function (layerSettings) {
                        return L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            subdomains: ['a', 'b', 'c']
                        });
                    },
                    SATELLITE: function (layerSettings) {
                        return L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Tiles © Esri'
                        });
                    }
                },
                tree: [
                    {
                        code: "root",
                        name: "All the Layers",
                        active: true,
                        selectedByDefault: false,
                        openByDefault: true,
                        selectType: "NONE",
                        serviceType: null,
                        params: {},
                        childLayers: [
                            {
                                code: "base",
                                name: "Base layers",
                                active: true,
                                selectedByDefault: false,
                                openByDefault: true,
                                selectType: "SINGLE",
                                serviceType: null,
                                params: {},
                                childLayers: [
                                    {
                                        code: "osm",
                                        name: "OpenStreetMap",
                                        active: true,
                                        selectedByDefault: true,
                                        openByDefault: true,
                                        childLayers: [],
                                        selectType: "NONE",
                                        serviceType: "OSM",
                                        params: {}
                                    }, 
                                    {
                                        code: "satellite",
                                        name: "Satellite",
                                        active: true,
                                        selectedByDefault: false,
                                        openByDefault: true,
                                        childLayers: [],
                                        selectType: "NONE",
                                        serviceType: "SATELLITE",
                                        params: {}
                                    }
                                ],
                            },
                            {
                                code: "overlays",
                                name: "Overlays",
                                active: true,
                                selectedByDefault: false,
                                openByDefault: true,
                                selectType: "MULTIPLE",
                                serviceType: null,
                                params: {},
                                childLayers: [

                                ],
                            }
                        ],
                    }
                ]
            }
        },
        methods: {
            initMap() {
                this.map = L.map('map', {
                    zoomControl: false,
                    contextmenu: true,
                    fullscreenControl: true,
                    fullscreenControlOptions: {
                        position: 'bottomright'
                    }
                }).setView([21.148023790045897, 105.62239681777376], 13)

                L.control.zoom({
                    position: 'bottomright'
                }).addTo(this.map);

                L.control.mousePosition().addTo(this.map);

                L.control.betterscale().addTo(this.map);

                L.easyButton('fa-home', function (btn, map) {
                    window.location.replace('/')
                }, "Go Home", { position: "bottomright" }).addTo(this.map);

                L.easyButton('fa-columns', (btn, map) => {
                    window.location.replace('compare')
                }, "Go to Compare Map", { position: "bottomright" }).addTo(this.map);

                L.easyButton('fa-paint-brush', (btn, map) => {
                    window.location.replace('draw')
                }, "Go to Draw Vector", { position: "bottomright" }).addTo(this.map);

                L.easyButton('fa-list', (btn, map) => {
                    if (this.showMenu) {
                        this.showMenu = false;
                        this.openSideBar = false;
                    } else {
                        this.showMenu = true;
                        this.openSideBar = true;
                    }
                }, "List all layers", { position: "bottomleft" }).addTo(this.map);

                // Thêm easy button để tìm kiếm tất cả feature service
                L.easyButton('arcgis-service', (btn, map) => {
                    this.searchAllFeatureServices();
                }, "Search all feature services", { position: "bottomleft" }).addTo(this.map);

                // Thêm easy button để tìm kiếm feature resources trong menu services
                L.easyButton('fa-search', (btn, map) => {
                    this.openFeatureSearchSidebar();
                }, "Search feature resources", { position: "bottomleft" }).addTo(this.map);

                L.Measure = {
                    linearMeasurement: "Distance measurement",
                    areaMeasurement: "Area measurement",
                    start: "Start",
                    meter: "m",
                    kilometer: "km",
                    squareMeter: "m²",
                    squareKilometers: "km²",
                };

                var measure = L.control.measure({
                    position: "bottomleft"
                }).addTo(this.map);

                // Close feature tooltip when clicking on map
                this.map.on('click', (e) => {
                    if (this.currentFeatureTooltip && !e.originalEvent.target.closest('.feature-tooltip')) {
                        this.closeFeatureTooltip();
                    }
                });

                this.getListLayer()

                this.updateLayerTree()
            },
            updateLayerTree() {
                if (this.layerTreeControl) {
                    this.layerTreeControl.remove(map);
                }
                if (!this.listLayer) {
                    this.listLayer = {}
                }

                for (let layer in this.listLayer) {
                    this.layerBuilders[layer] = function (layerSettings) {
                        return L.tileLayer(`api/images/${layer}/jp2/tiles/{z}/{x}/{y}.png/`, {
                            maxZoom: 20,
                            attribution: `${layer} JP2 Layer`
                        });
                    }
                }

                let custom_layers = []

                for (let layer in this.listLayer) {
                    let coords = this.listLayer[layer]['coords'][0]
                    custom_layers.push({
                        code: layer,
                        name: this.listLayer[layer]['name'] ? this.listLayer[layer]['name'] : layer,
                        active: true,
                        selectedByDefault: false,
                        openByDefault: true,
                        childLayers: [],
                        coord: [(coords[2][1] + coords[0][1])/2, (coords[0][0] + coords[2][0])/2],
                        selectType: "NONE",
                        serviceType: layer,
                        params: {},
                        callback: () => {
                            (this.saveSideBar || (() => {}))();
                        }
                    })
                }

                this.tree[0].childLayers[1].childLayers = custom_layers
                this.layerTreeControl = new L.Control.LayerTreeControl({
                    layerTree: this.tree,
                    openByDefault: true,
                    layerBuilders: this.layerBuilders,
                    featureBuilders: {
                        WFS: {
                            zoom: L.Control.LayerTreeControl.WFSZoomFeature
                        }
                    }
                })
                this.layerTreeControl.addTo(this.map);
            },
            initiateOAuth() {
                const state = btoa(Math.random().toString(36));
                localStorage.setItem('oauth_state', state);
                
                const params = new URLSearchParams({
                    client_id: this.arcgisConfig.clientId,
                    response_type: 'code',
                    redirect_uri: this.arcgisConfig.redirectUri,
                    state: state,
                    expiration: 20160
                });

                window.location.href = `${this.arcgisConfig.portalUrl}/sharing/rest/oauth2/authorize?${params}`;
            },
            
            async generateToken(username, password) {
                try {
                    const params = new URLSearchParams({
                        username: username,
                        password: password,
                        client: 'referer',
                        referer: window.location.origin,
                        f: 'json',
                        expiration: 20160,
                        portal: this.arcgisConfig.portalUrl
                    });

                    const response = await fetch(`${this.arcgisConfig.portalUrl}/sharing/rest/generateToken`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Referer': window.location.origin
                        },
                        body: params
                    });

                    if (!response.ok) throw new Error('Token generation failed');

                    const data = await response.json();
                    if (data.token) {
                        localStorage.setItem('arcgis_token', data.token);
                        this.arcgisToken = data.token;
                        this.showLoginButton = false;
                        return true;
                    } else {
                        throw new Error('No token received');
                    }
                } catch (error) {
                    console.error('Token generation error:', error);
                    return false;
                }
            },
            
            async loginWithCredentials() {
                try {
                    const success = await this.generateToken(this.loginForm.username, this.loginForm.password);
                    if (success) {
                        // Clear form
                        this.loginForm.username = '';
                        this.loginForm.password = '';
                        alert('Login successful!');
                    } else {
                        alert('Login failed. Please check your credentials.');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    alert('Login failed. Please try again.');
                }
            },
            
            loadMenuFromStorage() {
                try {
                    const stored = localStorage.getItem('menu_services');
                    if (stored) {
                        this.menuServices = JSON.parse(stored);
                        // Khôi phục trạng thái visible của các services
                        this.restoreServiceVisibility();
                    }
                } catch (error) {
                    console.error('Error loading menu from storage:', error);
                    this.menuServices = [];
                }
            },
            
            restoreServiceVisibility() {
                this.menuServices.forEach(service => {
                    if (service.visible) {
                        // Khôi phục các sublayers đã visible
                        service.sublayers.forEach(sublayer => {
                            if (sublayer.visible) {
                                this.addSublayerToMap(service, sublayer);
                            }
                        });
                    }
                });
            },

            clearAllLayers() {
                if (confirm('Bạn có chắc chắn muốn xóa tất cả layers khỏi map?')) {
                    if (this.listVectorLayer) {
                        Object.keys(this.listVectorLayer).forEach(key => {
                            this.listVectorLayer[key].remove();
                            delete this.listVectorLayer[key];
                        });
                    }
                    
                    // Reset trạng thái visible của tất cả services
                    this.menuServices.forEach(service => {
                        service.visible = false;
                        service.sublayers.forEach(sublayer => {
                            sublayer.visible = false;
                        });
                    });
                    
                    // Lưu trạng thái mới
                    this.saveMenuToStorage();
                    
                    alert('Đã xóa tất cả layers khỏi map!');
                }
            },

            getActiveLayersCount() {
                let count = 0;
                this.menuServices.forEach(service => {
                    if (service.visible) {
                        service.sublayers.forEach(sublayer => {
                            if (sublayer.visible) {
                                count++;
                            }
                        });
                    }
                });
                return count;
            },
            
            saveMenuToStorage() {
                try {
                    localStorage.setItem('menu_services', JSON.stringify(this.menuServices));
                } catch (error) {
                    console.error('Error saving menu to storage:', error);
                }
            },
            
            addToMenu(feature) {
                const existingIndex = this.menuServices.findIndex(service => service.id === feature.id);
                if (existingIndex === -1) {
                    // Tạo service object với sublayers
                    const service = {
                        id: feature.id,
                        name: feature.title,
                        url: feature.url,
                        owner: feature.owner,
                        modified: feature.modified,
                        visible: false,
                        sublayers: []
                    };
                    
                    // Lấy thông tin sublayers
                    this.getServiceLayers(service).then(() => {
                        this.menuServices.push(service);
                        this.saveMenuToStorage();
                    });
                }
            },
            
            async getServiceLayers(service) {
                try {
                    const response = await fetch(`${service.url}/layers?f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch service layers');
                    }
                    
                    const layersData = await response.json();
                    
                    if (layersData.layers && layersData.layers.length > 0) {
                        service.sublayers = layersData.layers.map(layer => ({
                            id: layer.id,
                            name: layer.name,
                            visible: false
                        }));
                    }
                } catch (error) {
                    console.error('Error getting service layers:', error);
                    service.sublayers = [];
                }
            },
            
            removeServiceFromMenu(serviceId) {
                // Xóa tất cả layers của service khỏi map
                this.removeServiceFromMap(serviceId);
                
                this.menuServices = this.menuServices.filter(service => service.id !== serviceId);
                this.saveMenuToStorage();
            },
            
            toggleServiceVisibility(service) {
                service.visible = !service.visible;
                
                if (service.visible) {
                    // Hiển thị tất cả sublayers
                    service.sublayers.forEach(sublayer => {
                        sublayer.visible = true;
                        this.addSublayerToMap(service, sublayer);
                    });
                } else {
                    // Ẩn tất cả sublayers
                    service.sublayers.forEach(sublayer => {
                        sublayer.visible = false;
                        this.removeSublayerFromMap(service.id, sublayer.id);
                    });
                }
                
                // Lưu trạng thái vào storage
                this.saveMenuToStorage();
            },
            
            toggleSublayerVisibility(service, sublayer) {
                sublayer.visible = !sublayer.visible;
                
                if (sublayer.visible) {
                    this.addSublayerToMap(service, sublayer);
                } else {
                    this.removeSublayerFromMap(service.id, sublayer.id);
                }
                
                // Cập nhật trạng thái visible của service dựa trên sublayers
                service.visible = service.sublayers.some(sl => sl.visible);
                
                // Lưu trạng thái vào storage
                this.saveMenuToStorage();
            },
            
            async addSublayerToMap(service, sublayer) {
                try {
                    const esriFeature = L.esri.featureLayer({
                        url: `${service.url}/${sublayer.id}?token=${this.arcgisToken}`,
                        // style: {
                        //     color: '#3388ff',
                        //     weight: 2,
                        //     opacity: 0.8,
                        //     fillOpacity: 0.2
                        // },
                        where: '1=1'
                    });
                    
                    // Add click event handler
                    esriFeature.on('click', (e) => {
                        this.handleFeatureClick(e, service, sublayer.id);
                    });
                    
                    esriFeature.addTo(this.map);
                    
                    // Store reference to remove later
                    if (!this.listVectorLayer) {
                        this.listVectorLayer = {};
                    }
                    const uniqueLayerKey = `${service.id}_${sublayer.id}`;
                    this.listVectorLayer[uniqueLayerKey] = esriFeature;
                    
                    console.log(`Added sublayer: ${sublayer.name} (ID: ${sublayer.id}) from service: ${service.name}`);
                    
                } catch (error) {
                    console.error('Error adding sublayer to map:', error);
                }
            },
            
            removeSublayerFromMap(serviceId, sublayerId) {
                if (this.listVectorLayer) {
                    const uniqueLayerKey = `${serviceId}_${sublayerId}`;
                    if (this.listVectorLayer[uniqueLayerKey]) {
                        this.listVectorLayer[uniqueLayerKey].remove();
                        delete this.listVectorLayer[uniqueLayerKey];
                        console.log(`Removed sublayer: ${uniqueLayerKey}`);
                    }
                }
            },
            
            removeServiceFromMap(serviceId) {
                if (this.listVectorLayer) {
                    // Remove all layers that belong to this service
                    const keysToRemove = Object.keys(this.listVectorLayer).filter(key => key.startsWith(`${serviceId}_`));
                    
                    keysToRemove.forEach(key => {
                        this.listVectorLayer[key].remove();
                        delete this.listVectorLayer[key];
                        console.log(`Removed service layer: ${key}`);
                    });
                    
                    if (keysToRemove.length === 0) {
                        console.log(`No layers found for service: ${serviceId}`);
                    }
                }
            },
            
            async handleFeatureClick(e, layer, layerId) {
                try {
                    const feature = e.layer.feature;
                    const objectId = feature.properties.objectid || feature.properties.OBJECTID;
                    
                    if (!objectId) {
                        console.error('No object ID found in feature');
                        this.showErrorTooltip(e.latlng, 'No object ID found in feature');
                        return;
                    }

                    // Show loading tooltip
                    this.showLoadingTooltip(e.latlng);

                    // Get feature details and attachments
                    const [featureDetails, attachments] = await Promise.all([
                        this.getFeatureDetails(layer.url, layerId, objectId),
                        this.getFeatureAttachments(layer.url, layerId, objectId)
                    ]);

                    if (!featureDetails) {
                        throw new Error('Feature details not found');
                    }

                    this.currentFeatureData = {
                        layer: layer,
                        layerId: layerId,
                        objectId: objectId,
                        feature: featureDetails,
                        attachments: attachments
                    };

                    this.showFeatureTooltip(e.latlng, featureDetails, attachments);
                    
                } catch (error) {
                    console.error('Error handling feature click:', error);
                    this.showErrorTooltip(e.latlng, 'Error loading feature details: ' + error.message);
                }
            },

            showLoadingTooltip(latlng) {
                if (this.currentFeatureTooltip) {
                    this.map.closePopup();
                }

                const loadingContent = `
                    <div class="feature-tooltip">
                        <div class="tooltip-header">
                            <span><i class="fas fa-spinner fa-spin"></i> Loading...</span>
                        </div>
                        <div class="tooltip-content">
                            <div class="loading">Loading feature details...</div>
                        </div>
                    </div>
                `;

                this.currentFeatureTooltip = L.popup({
                    className: 'feature-tooltip',
                    closeButton: true,
                    maxWidth: 300
                })
                .setLatLng(latlng)
                .setContent(loadingContent)
                .openOn(this.map);
            },

            showErrorTooltip(latlng, message) {
                if (this.currentFeatureTooltip) {
                    this.map.closePopup();
                }

                const errorContent = `
                    <div class="feature-tooltip">
                        <div class="tooltip-header">
                            <span><i class="fas fa-exclamation-triangle"></i> Error</span>
                        </div>
                        <div class="tooltip-content">
                            <div class="error">${message}</div>
                            <div class="tooltip-actions">
                                <button class="btn btn-secondary" onclick="app.closeFeatureTooltip()">Close</button>
                            </div>
                        </div>
                    </div>
                `;

                this.currentFeatureTooltip = L.popup({
                    className: 'feature-tooltip',
                    closeButton: true,
                    maxWidth: 300
                })
                .setLatLng(latlng)
                .setContent(errorContent)
                .openOn(this.map);
            },

            async getFeatureDetails(layerUrl, layerId, objectId) {
                try {
                    const response = await fetch(`${layerUrl}/${layerId}/query?where=OBJECTID=${objectId}&outFields=*&f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch feature details');
                    
                    const data = await response.json();
                    return data.features && data.features.length > 0 ? data.features[0] : null;
                } catch (error) {
                    console.error('Error getting feature details:', error);
                    throw error;
                }
            },

            async getFeatureAttachments(layerUrl, layerId, objectId) {
                try {
                    const response = await fetch(`${layerUrl}/${layerId}/${objectId}/attachments?f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch attachments');
                    
                    const data = await response.json();
                    return data.attachmentInfos || [];
                } catch (error) {
                    console.error('Error getting attachments:', error);
                    return [];
                }
            },

            showFeatureTooltip(latlng, feature, attachments) {
                // Remove existing tooltip
                if (this.currentFeatureTooltip) {
                    this.map.closePopup();
                    this.currentFeatureTooltip = null;
                }

                const tooltipContent = this.createTooltipContent(feature, attachments);
                
                this.currentFeatureTooltip = L.popup({
                    className: 'feature-tooltip',
                    closeButton: true,
                    maxWidth: 600,
                    maxHeight: 600
                })
                .setLatLng(latlng)
                .setContent(tooltipContent)
                .openOn(this.map);
            },

            createTooltipContent(feature, attachments) {
                const container = document.createElement('div');
                container.className = 'feature-tooltip-container';
                
                // Header
                const header = document.createElement('div');
                header.className = 'tooltip-header';
                const objectId = feature.attributes.objectid || feature.attributes.OBJECTID;
                header.innerHTML = `
                    <span><i class="fas fa-map-marker-alt"></i> Feature Details</span>
                    <span>ID: ${objectId}</span>
                `;
                container.appendChild(header);

                // Content
                const content = document.createElement('div');
                content.className = 'tooltip-content';
                
                // Add feature info section
                const infoSection = this.createFeatureInfoSection(feature);
                content.appendChild(infoSection);
                
                // Metadata section
                const metadataSection = this.createMetadataSection(feature);
                content.appendChild(metadataSection);
                
                // Attachments section
                const attachmentsSection = this.createAttachmentsSection(attachments);
                content.appendChild(attachmentsSection);
                
                // Actions
                const actionsSection = this.createActionsSection();
                content.appendChild(actionsSection);
                
                container.appendChild(content);
                return container;
            },

            createFeatureInfoSection(feature) {
                const section = document.createElement('div');
                section.className = 'feature-info-section';
                section.style.marginBottom = '15px';
                section.style.padding = '10px';
                section.style.backgroundColor = '#f8f9fa';
                section.style.borderRadius = '4px';
                
                const title = document.createElement('h4');
                title.textContent = 'Feature Information';
                title.style.marginBottom = '8px';
                title.style.fontWeight = 'bold';
                title.style.fontSize = '14px';
                section.appendChild(title);
                
                const infoGrid = document.createElement('div');
                infoGrid.style.display = 'grid';
                infoGrid.style.gridTemplateColumns = '1fr 1fr';
                infoGrid.style.gap = '8px';
                infoGrid.style.fontSize = '12px';
                
                const attributes = feature.attributes;
                const objectId = attributes.objectid || attributes.OBJECTID;
                const featureType = this.currentFeatureData?.layer?.name || 'Unknown';
                const layerId = this.currentFeatureData?.layerId || 'Unknown';
                
                const infoItems = [
                    { label: 'Feature ID', value: objectId },
                    { label: 'Layer', value: featureType },
                    { label: 'Layer ID', value: layerId },
                    { label: 'Geometry Type', value: feature.geometry?.type || 'Unknown' }
                ];
                
                infoItems.forEach(item => {
                    const infoItem = document.createElement('div');
                    infoItem.style.display = 'flex';
                    infoItem.style.justifyContent = 'space-between';
                    
                    const label = document.createElement('span');
                    label.textContent = item.label + ':';
                    label.style.fontWeight = '500';
                    label.style.color = '#666';
                    
                    const value = document.createElement('span');
                    value.textContent = item.value;
                    value.style.fontWeight = '600';
                    value.style.color = '#333';
                    
                    infoItem.appendChild(label);
                    infoItem.appendChild(value);
                    infoGrid.appendChild(infoItem);
                });
                
                section.appendChild(infoGrid);
                return section;
            },

            createMetadataSection(feature) {
                const section = document.createElement('div');
                section.className = 'metadata-section';
                
                const title = document.createElement('h4');
                title.textContent = 'Metadata';
                title.style.marginBottom = '10px';
                title.style.fontWeight = 'bold';
                section.appendChild(title);
                
                const grid = document.createElement('div');
                grid.className = 'metadata-grid';
                
                const attributes = feature.attributes;
                
                // Get all available fields from the feature
                const allFields = Object.keys(attributes).filter(key => 
                    key !== 'OBJECTID' && 
                    key !== 'objectid' && 
                    key !== 'SHAPE' && 
                    key !== 'shape' &&
                    key !== 'FID' &&
                    key !== 'fid'
                );
                
                // Define special fields that should be textareas (long text fields)
                const textareaFields = ['mo_ta', 'description', 'desc', 'notes', 'comments', 'remarks', 'mota', 'ghichu'];
                
                // Define fields that should be hidden (system fields)
                const hiddenFields = ['created_user', 'created_date', 'last_edited_user', 'last_edited_date', 'globalid', 'shape_length', 'shape_area'];
                
                // Filter out hidden fields
                const visibleFields = allFields.filter(field => !hiddenFields.includes(field.toLowerCase()));
                
                // Sort fields: text fields first, then textarea fields
                const textFields = visibleFields.filter(field => !textareaFields.includes(field.toLowerCase()));
                const longTextFields = visibleFields.filter(field => textareaFields.includes(field.toLowerCase()));
                
                // Create input fields for regular text fields
                textFields.forEach(field => {
                    const item = document.createElement('div');
                    item.className = 'metadata-item';
                    
                    const label = document.createElement('label');
                    label.textContent = this.formatFieldName(field);
                    
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = attributes[field] || '';
                    input.dataset.field = field;
                    input.placeholder = `Enter ${this.formatFieldName(field)}`;
                    
                    item.appendChild(label);
                    item.appendChild(input);
                    grid.appendChild(item);
                });
                
                section.appendChild(grid);
                
                // Create textarea fields for long text
                longTextFields.forEach(field => {
                    const textareaSection = document.createElement('div');
                    textareaSection.style.gridColumn = '1 / -1'; // Span full width
                    textareaSection.style.marginTop = '15px';
                    
                    const textareaLabel = document.createElement('label');
                    textareaLabel.textContent = this.formatFieldName(field);
                    textareaLabel.style.display = 'block';
                    textareaLabel.style.marginBottom = '5px';
                    textareaLabel.style.fontWeight = 'bold';
                    
                    const textarea = document.createElement('textarea');
                    textarea.value = attributes[field] || '';
                    textarea.dataset.field = field;
                    textarea.placeholder = `Enter ${this.formatFieldName(field)}...`;
                    textarea.style.width = '100%';
                    textarea.style.minHeight = '80px';
                    textarea.style.padding = '8px';
                    textarea.style.border = '1px solid #ddd';
                    textarea.style.borderRadius = '4px';
                    textarea.style.fontSize = '12px';
                    textarea.style.fontFamily = 'inherit';
                    textarea.style.resize = 'vertical';
                    
                    textareaSection.appendChild(textareaLabel);
                    textareaSection.appendChild(textarea);
                    section.appendChild(textareaSection);
                });
                
                // If no fields found, show a message
                if (visibleFields.length === 0) {
                    const noFieldsMsg = document.createElement('p');
                    noFieldsMsg.textContent = 'No editable metadata fields found for this feature.';
                    noFieldsMsg.style.color = '#666';
                    noFieldsMsg.style.fontStyle = 'italic';
                    noFieldsMsg.style.textAlign = 'center';
                    noFieldsMsg.style.padding = '20px';
                    section.appendChild(noFieldsMsg);
                }
                
                return section;
            },

            formatFieldName(fieldName) {
                // Convert field name to readable format
                return fieldName
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase())
                    .trim();
            },

            createAttachmentsSection(attachments) {
                const section = document.createElement('div');
                section.className = 'attachments-section';
                
                const title = document.createElement('h4');
                title.textContent = 'Attachments';
                title.style.marginBottom = '10px';
                title.style.fontWeight = 'bold';
                section.appendChild(title);
                
                if (attachments.length === 0) {
                    const noAttachments = document.createElement('p');
                    noAttachments.textContent = 'No attachments found';
                    noAttachments.style.color = '#666';
                    noAttachments.style.fontStyle = 'italic';
                    section.appendChild(noAttachments);
                } else {
                    // Create gallery container
                    const galleryContainer = document.createElement('div');
                    galleryContainer.className = 'attachments-gallery';
                    
                    attachments.forEach(attachment => {
                        const item = document.createElement('div');
                        item.className = 'attachment-gallery-item';
                        
                        // Determine if it's a media file
                        const isImage = attachment.contentType && attachment.contentType.startsWith('image/');
                        const isVideo = attachment.contentType && attachment.contentType.startsWith('video/');
                        const isAudio = attachment.contentType && attachment.contentType.startsWith('audio/');
                        
                        let mediaContent = '';
                        let isMediaFile = isImage || isVideo || isAudio;
                        
                        if (isImage) {
                            mediaContent = `
                                <div class="media-thumbnail" style="margin-bottom: 8px;">
                                    <img src="${this.getAttachmentUrl(attachment.id)}" 
                                         alt="${attachment.name}" 
                                         class="preview-img">
                                    <div class="media-overlay">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                </div>
                            `;
                        } else if (isVideo) {
                            mediaContent = `
                                <div class="media-thumbnail" style="margin-bottom: 8px;">
                                    <video class="video-thumbnail">
                                        <source src="${this.getAttachmentUrl(attachment.id)}" type="${attachment.contentType}">
                                    </video>
                                    <div class="media-overlay">
                                        <i class="fas fa-play"></i>
                                    </div>
                                </div>
                            `;
                        } else if (isAudio) {
                            mediaContent = `
                                <div class="media-thumbnail" style="margin-bottom: 8px;">
                                    <div class="audio-thumbnail">
                                        <i class="fas fa-music"></i>
                                    </div>
                                    <div class="media-overlay">
                                        <i class="fas fa-play"></i>
                                    </div>
                                </div>
                            `;
                        } else {
                            mediaContent = `
                                <div class="file-icon">
                                    <i class="fas fa-file"></i>
                                </div>
                            `;
                        }
                        
                        item.innerHTML = `
                            ${mediaContent}
                            <div style="font-size: 12px; font-weight: bold; margin-bottom: 5px; word-break: break-word;">
                                ${attachment.name}
                            </div>
                            <div style="display: flex; gap: 5px; justify-content: center;">
                                <button class="btn btn-secondary download-btn" style="padding: 4px 8px; font-size: 10px;" 
                                        data-attachment-id="${attachment.id}" 
                                        title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-danger delete-btn" style="padding: 4px 8px; font-size: 10px;" 
                                        data-attachment-id="${attachment.id}" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `;
                        
                        // Add event listeners after creating the element
                        const downloadBtn = item.querySelector('.download-btn');
                        const deleteBtn = item.querySelector('.delete-btn');
                        const mediaThumbnail = item.querySelector('.media-thumbnail');
                        
                        downloadBtn.addEventListener('click', () => {
                            this.downloadAttachment(attachment.id);
                        });
                        
                        deleteBtn.addEventListener('click', () => {
                            this.deleteAttachment(attachment.id);
                        });
                        
                        if (mediaThumbnail) {
                            mediaThumbnail.addEventListener('click', () => {
                                this.previewAttachment(attachment.id, attachment.name, attachment.contentType);
                            });
                        }
                        
                        galleryContainer.appendChild(item);
                    });
                    
                    section.appendChild(galleryContainer);
                }
                
                // Add attachment button
                const addButton = document.createElement('button');
                addButton.className = 'btn btn-success';
                addButton.innerHTML = '<i class="fas fa-plus"></i> Add Attachment';
                addButton.onclick = () => this.addAttachment();
                addButton.style.marginTop = '10px';
                section.appendChild(addButton);
                
                return section;
            },

            getAttachmentUrl(attachmentId) {
                if (!this.currentFeatureData) return '';
                const { layer, layerId, objectId } = this.currentFeatureData;
                return `${layer.url}/${layerId}/${objectId}/attachments/${attachmentId}?token=${this.arcgisToken}`;
            },

            previewAttachment(attachmentId, fileName, contentType) {
                const url = this.getAttachmentUrl(attachmentId);
                
                // Create modal for preview
                const modal = document.createElement('div');
                modal.className = 'preview-modal';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'preview-modal-content';
                
                const closeBtn = document.createElement('button');
                closeBtn.className = 'preview-modal-close';
                closeBtn.innerHTML = '×';
                closeBtn.onclick = () => document.body.removeChild(modal);
                
                const title = document.createElement('h3');
                title.textContent = fileName;
                title.style.marginBottom = '15px';
                
                let mediaElement = '';
                
                if (contentType.startsWith('image/')) {
                    mediaElement = `
                        <div style="text-align: center;">
                            <img src="${url}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        </div>
                    `;
                } else if (contentType.startsWith('video/')) {
                    mediaElement = `
                        <div style="text-align: center;">
                            <video controls style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <source src="${url}" type="${contentType}">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    `;
                } else if (contentType.startsWith('audio/')) {
                    mediaElement = `
                        <div style="text-align: center; padding: 20px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 8px; margin-bottom: 20px;">
                                <i class="fas fa-music" style="font-size: 4em; color: white;"></i>
                            </div>
                            <audio controls style="width: 100%; max-width: 400px;">
                                <source src="${url}" type="${contentType}">
                                Your browser does not support the audio tag.
                            </audio>
                        </div>
                    `;
                } else {
                    mediaElement = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-file" style="font-size: 3em; color: #6c757d;"></i>
                            <p>Preview not available for this file type</p>
                            <a href="${url}" download="${fileName}" class="btn btn-primary">Download File</a>
                        </div>
                    `;
                }
                
                modalContent.innerHTML = `
                    ${closeBtn.outerHTML}
                    ${title.outerHTML}
                    ${mediaElement}
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                };
            },

            createActionsSection() {
                const section = document.createElement('div');
                section.className = 'tooltip-actions';
                
                const saveBtn = document.createElement('button');
                saveBtn.className = 'btn btn-primary';
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
                saveBtn.onclick = () => this.saveFeatureChanges();
                
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'btn btn-secondary';
                cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                cancelBtn.onclick = () => this.closeFeatureTooltip();
                
                section.appendChild(cancelBtn);
                section.appendChild(saveBtn);
                
                return section;
            },

            async saveFeatureChanges() {
                if (!this.currentFeatureData) {
                    alert('No feature data to save');
                    return;
                }

                try {
                    const { layer, layerId, objectId, feature } = this.currentFeatureData;
                    
                    // Collect updated attributes from form inputs and textareas
                    const originalAttributes = feature.attributes;
                    const updatedAttributes = {};
                    const inputs = document.querySelectorAll('.feature-tooltip input[data-field]');
                    const textareas = document.querySelectorAll('.feature-tooltip textarea[data-field]');
                    
                    // Helper function to check if value is valid and has changed
                    const hasValidChange = (field, value) => {
                        const originalValue = originalAttributes[field];
                        const trimmedValue = value.trim();
                        
                        // If original value was null/undefined/empty, only send if new value is not empty
                        if (!originalValue || originalValue === '' || originalValue === null || originalValue === undefined) {
                            return trimmedValue !== '';
                        }
                        
                        // If original value existed, send if new value is different
                        return trimmedValue !== originalValue;
                    };
                    
                    // Process all input fields
                    inputs.forEach(input => {
                        const field = input.dataset.field;
                        const value = input.value;
                        
                        if (hasValidChange(field, value)) {
                            updatedAttributes[field] = value.trim();
                        }
                    });
                    
                    // Process all textarea fields
                    textareas.forEach(textarea => {
                        const field = textarea.dataset.field;
                        const value = textarea.value;
                        
                        if (hasValidChange(field, value)) {
                            updatedAttributes[field] = value.trim();
                        }
                    });

                    // Only proceed if there are valid changes
                    if (Object.keys(updatedAttributes).length === 0) {
                        alert('No changes detected to save');
                        return;
                    }

                    console.log('Updating fields:', updatedAttributes);

                    // Prepare update payload with only changed fields
                    const updatePayload = {
                        features: [{
                            attributes: {
                                OBJECTID: objectId,
                                ...updatedAttributes
                            },
                            geometry: feature.geometry
                        }]
                    };

                    // Send update request
                    const response = await fetch(`${layer.url}/${layerId}/updateFeatures`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Referer': window.location.origin
                        },
                        body: new URLSearchParams({
                            f: 'json',
                            token: this.arcgisToken,
                            features: JSON.stringify(updatePayload.features)
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Update failed with status:', response.status, 'Error:', errorText);
                        throw new Error(`Failed to update feature: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('Update result:', result);
                    
                    if (result.updateResults && result.updateResults.length > 0 && result.updateResults[0].success) {
                        alert('Feature updated successfully!');
                        this.closeFeatureTooltip();
                    } else {
                        console.error('Update result indicates failure:', result);
                        throw new Error('Update failed - server returned error');
                    }

                } catch (error) {
                    console.error('Error saving feature changes:', error);
                    alert('Error saving changes: ' + error.message);
                }
            },

            closeFeatureTooltip() {
                if (this.currentFeatureTooltip) {
                    this.map.closePopup();
                    this.currentFeatureTooltip = null;
                    this.currentFeatureData = null;
                }
            },

            async downloadAttachment(attachmentId) {
                if (!this.currentFeatureData) return;

                try {
                    const { layer, layerId, objectId } = this.currentFeatureData;
                    const response = await fetch(`${layer.url}/${layerId}/${objectId}/attachments/${attachmentId}?token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });

                    if (!response.ok) throw new Error('Failed to download attachment');

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `attachment_${attachmentId}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                } catch (error) {
                    console.error('Error downloading attachment:', error);
                    alert('Error downloading attachment');
                }
            },

            async deleteAttachment(attachmentId) {
                if (!this.currentFeatureData) return;

                if (!confirm('Are you sure you want to delete this attachment?')) return;

                try {
                    const { layer, layerId, objectId } = this.currentFeatureData;
                    const response = await fetch(`${layer.url}/${layerId}/${objectId}/deleteAttachments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Referer': window.location.origin
                        },
                        body: new URLSearchParams({
                            f: 'json',
                            token: this.arcgisToken,
                            attachmentIds: attachmentId
                        })
                    });

                    console.log('Delete response status:', response.status);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('Delete failed with status:', response.status, 'Error:', errorText);
                        throw new Error(`Failed to delete attachment: ${response.status} - ${errorText}`);
                    }

                    const result = await response.json();
                    console.log('Delete response result:', result);
                    
                    // Check different possible success indicators
                    const isSuccess = (
                        (result.deleteAttachmentResults && result.deleteAttachmentResults.length > 0 && result.deleteAttachmentResults[0].success === true) ||
                        (result.success === true) ||
                        (result.error === undefined && result.deleteAttachmentResults) ||
                        (response.status >= 200 && response.status < 300)
                    );
                    
                    if (isSuccess) {
                        alert('Attachment deleted successfully!');
                        // Refresh the tooltip
                        this.refreshFeatureTooltip();
                    } else {
                        console.error('Delete result indicates failure:', result);
                        throw new Error('Delete failed - server returned error');
                    }

                } catch (error) {
                    console.error('Error deleting attachment:', error);
                    alert('Error deleting attachment');
                }
            },

            async addAttachment() {
                if (!this.currentFeatureData) return;

                // Create file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '*/*';
                fileInput.style.display = 'none';
                document.body.appendChild(fileInput);

                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        const { layer, layerId, objectId } = this.currentFeatureData;
                        const formData = new FormData();
                        formData.append('attachment', file);
                        formData.append("f", "json");   

                        const response = await fetch(`${layer.url}/${layerId}/${objectId}/addAttachment?token=${this.arcgisToken}&f=json`, {
                            method: 'POST',
                            headers: {
                                'Referer': window.location.origin
                            },
                            body: formData
                        });

                        console.log('Upload response status:', response.status);
                        console.log('Upload response headers:', response.headers);
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            console.error('Upload failed with status:', response.status, 'Error:', errorText);
                            throw new Error(`Failed to add attachment: ${response.status} - ${errorText}`);
                        }

                        const result = await response.json();
                        console.log('Upload response result:', result);
                        
                        // Check different possible success indicators
                        const isSuccess = (
                            (result.addAttachmentResult && result.addAttachmentResult.success === true) ||
                            (result.success === true) ||
                            (result.error === undefined && result.addAttachmentResult) ||
                            (response.status >= 200 && response.status < 300)
                        );
                        
                        if (isSuccess) {
                            alert('Attachment added successfully!');
                            this.refreshFeatureTooltip();
                        } else {
                            console.error('Upload result indicates failure:', result);
                            throw new Error('Add attachment failed - server returned error');
                        }

                    } catch (error) {
                        console.error('Error adding attachment:', error);
                        alert('Error adding attachment');
                    } finally {
                        document.body.removeChild(fileInput);
                    }
                };

                fileInput.click();
            },

            async refreshFeatureTooltip() {
                if (!this.currentFeatureData) return;

                try {
                    const { layer, layerId, objectId } = this.currentFeatureData;
                    
                    // Get updated feature details and attachments
                    const [featureDetails, attachments] = await Promise.all([
                        this.getFeatureDetails(layer.url, layerId, objectId),
                        this.getFeatureAttachments(layer.url, layerId, objectId)
                    ]);

                    this.currentFeatureData.feature = featureDetails;
                    this.currentFeatureData.attachments = attachments;

                    // Update tooltip content
                    if (this.currentFeatureTooltip) {
                        const tooltipContent = this.createTooltipContent(featureDetails, attachments);
                        this.currentFeatureTooltip.setContent(tooltipContent);
                    }

                } catch (error) {
                    console.error('Error refreshing tooltip:', error);
                }
            },
            
            filterSearchResults() {
                if (!this.searchResults.features) return [];
                
                return this.searchResults.features.filter(feature => {
                    let matches = true;
                    
                    if (this.filterForm.name && !feature.title.toLowerCase().includes(this.filterForm.name.toLowerCase())) {
                        matches = false;
                    }
                    
                    if (this.filterForm.owner && !feature.owner.toLowerCase().includes(this.filterForm.owner.toLowerCase())) {
                        matches = false;
                    }
                    
                    if (this.filterForm.dateFrom || this.filterForm.dateTo) {
                        const modifiedDate = new Date(feature.modified);
                        
                        if (this.filterForm.dateFrom) {
                            const fromDate = new Date(this.filterForm.dateFrom);
                            if (modifiedDate < fromDate) matches = false;
                        }
                        
                        if (this.filterForm.dateTo) {
                            const toDate = new Date(this.filterForm.dateTo);
                            if (modifiedDate > toDate) matches = false;
                        }
                    }
                    
                    return matches;
                });
            },
            
            isInMenu(featureId) {
                return this.menuServices.some(service => service.id === featureId);
            },
            
            toggleMenuLayer(feature) {
                if (this.isInMenu(feature.id)) {
                    this.removeServiceFromMenu(feature.id);
                } else {
                    this.addToMenu(feature);
                }
            },
            
            closeSideBar() {
                this.openSideBar = false;
                this.showMenu = false;
                this.showFeatureSearch = false;
                
                // KHÔNG xóa layers khỏi map khi đóng sidebar
                // Chỉ đóng sidebar, giữ nguyên các layers đã hiển thị
                
                // Lưu trạng thái hiện tại vào storage
                this.saveMenuToStorage();
            },
            async validateToken() {
                console.log("VALIDATE TOKEN")
                const storedToken = localStorage.getItem('arcgis_token');
                if (!storedToken) {
                    this.showLoginButton = true
                    return false;
                }

                try {
                    const response = await fetch(`${this.arcgisConfig.portalUrl}/sharing/rest/portals/self?f=json&token=${storedToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    const data = await response.json();
                    if (data.error) {
                        localStorage.removeItem('arcgis_token');
                        this.showLoginButton = true
                        return false;
                    } else {
                        this.showLoginButton = false
                    }
                    token = storedToken;
                    this.arcgisToken = storedToken;
                    // showUserInfo(data.user);
                    return true;
                } catch (error) {
                    console.error('Token validation failed:', error);
                    localStorage.removeItem('arcgis_token');
                    this.showLoginButton = true
                    return false;
                }
            },
            async performSearch(searchParams) {
                try {
                    this.searchLoading = true;
    
                    // Build search parameters for ArcGIS Portal
                    const params = new URLSearchParams({
                        q: "type:\"Feature Service\"",
                        f: 'json',
                        token: this.arcgisToken,
                        num: 50
                    });
    
                    // Add additional search criteria if provided
                    if (searchParams && searchParams.bbox) {
                        params.append('bbox', `${searchParams.bbox.west},${searchParams.bbox.south},${searchParams.bbox.east},${searchParams.bbox.north}`);
                    }
    
                    // Make API request to ArcGIS Portal search
                    const response = await fetch(`${this.arcgisConfig.portalUrl}/sharing/rest/search?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Referer': window.location.origin
                        }
                    });
    
                    if (!response.ok) throw new Error('Search request failed');
    
                    const results = await response.json();
                    console.log(results)
                    this.searchLoading = false;
                    this.searchResults = { "features": results.results || [] }
                    
                    // If we have results, get attachments for the first one
                    if (this.searchResults.features.length > 0) {
                        this.getAttachments(this.searchResults.features[0].url, this.searchResults.features[0].id)
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    this.showSearchError = true;
                    this.searchLoading = false;
                }
            },
            getListLayer() {
                try {
                    this.listLayer = JSON.parse(window.localStorage.getItem("layers"));
                } catch (e) {
                    console.log(e)
                    this.listLayer = {}
                }
                if (!this.listLayer) {
                    this.listLayer = {}
                }
            },
            async getAttachments(layerUrl, featureId) {
                try {
                    const response = await fetch(`${layerUrl}/${featureId}/attachments?f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    const data = await response.json();
                    console.log(data)
                    // displayAttachments(data.attachmentInfos);
                } catch (error) {
                    console.error('Failed to get attachments:', error);
                }
            },
            toggleFilter() {
              this.expandFilter = !this.expandFilter  
            },
            closeSearchSideBar() {
                this.closeSideBar();
            },
            closeModal() {
                this.openModal = false;
            },
            submitModal() {
                if (!this.uploadImage.name || !this.uploadImage.file) {
                    alert('Please provide a name and select a file.');
                    return;
                }
    
                const formData = new FormData();
                formData.append('name', this.uploadImage.name);
                formData.append('datetime', this.uploadImage.datetime)
                formData.append('source', this.uploadImage.source)
                formData.append('format', this.uploadImage.format)
                formData.append('satellite_id', this.uploadImage.satellite)
                formData.append('file', this.uploadImage.file);
    
                const xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/images/upload_image/', true);
    
                // Update progress bar
                xhr.upload.onprogress = (event) => {
                    if (event.lengthComputable) {
                        let percentComplete = (event.loaded / event.total) * 100;
                        if (percentComplete >= 98) {
                            percentComplete = 98
                        }
                        this.progressBar = percentComplete;
                    }
                };
    
                // Handle success and error
                xhr.onload = () => {
                    if (xhr.status === 200 || xhr.status === 201) {
                        this.progressBar = 100; // Reset progress bar
                        alert('Upload successful!');
                        this.closeModal();
                    } else {
                        alert('Upload failed. Please try again.');
                        this.closeModal();
                    }
                };
    
                xhr.onerror = () => {
                    alert('An error occurred during the upload.');
                    this.closeModal();
                };
    
                xhr.send(formData);
            },
            
            async searchAllFeatureServices() {
                try {
                    this.searchLoading = true;
                    this.showSearchError = false;
                    this.openSideBar = true;
                    this.showMenu = false;
    
                    // Build search parameters for ArcGIS Portal
                    const params = new URLSearchParams({
                        q: "type:\"Feature Service\"",
                        f: 'json',
                        token: this.arcgisToken,
                        num: 100 // Tăng số lượng kết quả
                    });
    
                    // Make API request to ArcGIS Portal search
                    const response = await fetch(`${this.arcgisConfig.portalUrl}/sharing/rest/search?${params}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Referer': window.location.origin
                        }
                    });
    
                    if (!response.ok) throw new Error('Search request failed');
    
                    const results = await response.json();
                    console.log('All feature services:', results);
                    this.searchLoading = false;
                    this.searchResults = { "features": results.results || [] }
                    
                } catch (error) {
                    console.error('Search error:', error);
                    this.showSearchError = true;
                    this.searchLoading = false;
                }
            },
            openFeatureSearchSidebar() {
                this.showFeatureSearch = true;
                this.openSideBar = true;
                this.showMenu = false;
            },
            closeFeatureSearchSidebar() {
                this.closeSideBar();
            },
            
            async searchFeatureResources() {
                // Clear previous timer
                if (this.featureSearchDebounceTimer) {
                    clearTimeout(this.featureSearchDebounceTimer);
                }
                
                // Set new timer for debounce
                this.featureSearchDebounceTimer = setTimeout(async () => {
                    if (!this.featureSearchQuery.trim()) {
                        this.featureSearchResults = [];
                        return;
                    }
                    
                    this.featureSearchLoading = true;
                    
                    try {
                        const results = [];
                        const query = this.featureSearchQuery;
                        
                        // Tìm kiếm trong tất cả services đã được thêm vào menu
                        for (const service of this.menuServices) {
                            // Chỉ tìm kiếm trong services đang visible
                            if (service.visible) {
                                const serviceResult = {
                                    id: service.id,
                                    name: service.name,
                                    owner: service.owner,
                                    url: service.url,
                                    layers: []
                                };
                                
                                // Tìm kiếm trong các layers visible của service
                                for (const layer of service.sublayers) {
                                    if (layer.visible) {
                                        const layerResult = {
                                            id: layer.id,
                                            name: layer.name,
                                            serviceName: service.name, // Thêm tên service
                                            resources: []
                                        };
                                        
                                        // Tìm kiếm features trong layer này
                                        const features = await this.searchFeaturesInLayer(service.url, layer.id, query);
                                        layerResult.resources = features;
                                        
                                        if (features.length > 0) {
                                            serviceResult.layers.push(layerResult);
                                        }
                                    }
                                }
                                
                                if (serviceResult.layers.length > 0) {
                                    results.push(serviceResult);
                                }
                            }
                        }
                        
                        this.featureSearchResults = results;
                        
                    } catch (error) {
                        console.error('Error searching feature resources:', error);
                        this.featureSearchResults = [];
                    } finally {
                        this.featureSearchLoading = false;
                    }
                }, 300); // Debounce 300ms
            },
            
            async searchFeaturesInLayer(serviceUrl, layerId, query) {
                try {
                    // Lấy thông tin layer trước
                    const layerInfo = await this.getLayerInfo(serviceUrl, layerId);
                    if (!layerInfo) {
                        console.error('Failed to get layer info');
                        return [];
                    }
                    
                    // Tạo WHERE clause dựa trên các trường có sẵn trong layer
                    const whereClause = this.buildWhereClause(layerInfo.fields, query);
                    
                    const response = await fetch(`${serviceUrl}/${layerId}/query?where=${encodeURIComponent(whereClause)}&outFields=*&f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch features');
                    
                    const data = await response.json();
                    const features = data.features || [];
                    
                    // Chuyển đổi thành format hiển thị
                    return features.map(feature => {
                        const attributes = feature.attributes || {};
                        const objectid = attributes.objectid || attributes.OBJECTID || 'Unknown';
                        
                        // Tìm tên hiển thị từ các trường có sẵn trong layer
                        const displayName = this.getDisplayName(attributes, layerInfo.fields);
                        
                        return {
                            objectid: objectid,
                            displayName: displayName,
                            attributes: attributes,
                            geometry: feature.geometry
                        };
                    });
                    
                } catch (error) {
                    console.error('Error searching features in layer:', error);
                    return [];
                }
            },
            
            async getLayerInfo(serviceUrl, layerId) {
                try {
                    const response = await fetch(`${serviceUrl}/${layerId}?f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch layer info');
                    
                    const layerInfo = await response.json();
                    return layerInfo;
                    
                } catch (error) {
                    console.error('Error getting layer info:', error);
                    return null;
                }
            },
            
            buildWhereClause(fields, query) {
                // Danh sách các trường có thể tìm kiếm
                const searchableFields = ['name', 'title', 'description', 'label', 'ten', 'mo_ta', 'NAME_VN', 'NAME_EN', 'NAME'];
                
                // Lọc các trường có sẵn trong layer
                const availableFields = fields
                    .filter(field => searchableFields.includes(field.name.toUpperCase()))
                    .map(field => field.name);
                
                if (availableFields.length === 0) {
                    // Nếu không có trường tìm kiếm, trả về điều kiện luôn đúng
                    return '1=1';
                }
                
                // Tạo WHERE clause với các trường có sẵn
                const conditions = availableFields.map(field => `${field} LIKE '%${query}%'`);
                return conditions.join(' OR ');
            },
            
            getDisplayName(attributes, fields) {
                // Danh sách các trường name theo thứ tự ưu tiên
                const nameFields = ['name_vn', 'name_en', 'name', 'title', 'description', 'label', 'ten', 'mo_ta'];
                
                // Tìm trường name có sẵn trong layer và có giá trị
                for (const fieldName of nameFields) {
                    if (attributes[fieldName] && attributes[fieldName].trim() !== '') {
                        return attributes[fieldName];
                    }
                }
                
                // Nếu không có trường name, trả về objectid
                return 'Feature ' + (attributes.objectid || attributes.OBJECTID || 'Unknown');
            },
            
            async focusOnResource(service, layer, resource) {
                try {
                    // Đóng sidebar tìm kiếm
                    this.closeFeatureSearchSidebar();
                    
                    // Sử dụng geometry có sẵn để focus
                    if (resource.geometry) {
                        let bounds;
                        let focusPoint;
                        
                        if (resource.geometry.rings === undefined && resource.geometry.paths === undefined) {
                            // Nếu là point, zoom vào với radius nhỏ
                            focusPoint = L.latLng(resource.geometry.y, resource.geometry.x);
                            this.map.setView(focusPoint, 16);
                            
                        } else if (resource.geometry.rings != undefined) {
                            // Nếu là polygon, tạo bounds từ coordinates
                            const coordinates = resource.geometry.rings[0];
                            const latlngs = coordinates.map(coord => L.latLng(coord[1], coord[0]));
                            bounds = L.latLngBounds(latlngs);
                            this.map.fitBounds(bounds, { padding: [50, 50] });
                            focusPoint = bounds.getCenter();
                            
                        } else if (resource.geometry.paths != undefined) {
                            // Nếu là polyline, tạo bounds từ coordinates
                            const coordinates = resource.geometry.paths[0];
                            const latlngs = coordinates.map(coord => L.latLng(coord[1], coord[0]));
                            bounds = L.latLngBounds(latlngs);
                            this.map.fitBounds(bounds, { padding: [50, 50] });
                            focusPoint = bounds.getCenter();
                        }
                        
                        // Hiển thị popup tại điểm focus
                        if (focusPoint) {
                            setTimeout(() => {
                                this.showFeatureTooltipAtLocation(focusPoint, service, layer.id, resource.objectid);
                            }, 500);
                        }
                        
                    } else {
                        // Nếu không có geometry, thử query lại để lấy geometry
                        const featureDetails = await this.getFeatureDetails(service.url, layer.id, resource.objectid);
                        if (featureDetails && featureDetails.geometry) {
                            this.focusOnResource(service, layer, {
                                ...resource,
                                geometry: featureDetails.geometry
                            });
                        } else {
                            // Nếu không có geometry, chỉ hiển thị thông báo
                            this.showSuccessMessage(`Đã focus vào resource: ${resource.displayName}`);
                        }
                    }
                    
                    // Hiển thị thông báo thành công
                    this.showSuccessMessage(`Đã focus vào resource: ${resource.displayName}`);
                    
                } catch (error) {
                    console.error('Error focusing on resource:', error);
                    alert('Không thể focus vào resource này');
                }
            },
            
            async showFeatureTooltipAtLocation(latlng, service, layerId, objectId) {
                try {
                    // Lấy feature details và attachments
                    const [featureDetails, attachments] = await Promise.all([
                        this.getFeatureDetails(service.url, layerId, objectId),
                        this.getFeatureAttachments(service.url, layerId, objectId)
                    ]);
                    
                    if (featureDetails) {
                        this.currentFeatureData = {
                            layer: service,
                            layerId: layerId,
                            objectId: objectId,
                            feature: featureDetails,
                            attachments: attachments
                        };
                        
                        this.showFeatureTooltip(latlng, featureDetails, attachments);
                    }
                    
                } catch (error) {
                    console.error('Error showing feature tooltip:', error);
                }
            },
            
            removeFeatureLayer(serviceId, layerId, objectId) {
                const layerKey = `${serviceId}_${layerId}_${objectId}`;
                if (this.listVectorLayer && this.listVectorLayer[layerKey]) {
                    this.listVectorLayer[layerKey].remove();
                    delete this.listVectorLayer[layerKey];
                    console.log(`Removed feature layer: ${layerKey}`);
                }
            },
            showSuccessMessage(message) {
                // Tạo element thông báo
                const notification = document.createElement('div');
                notification.className = 'success-message';
                notification.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-check-circle"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                // Thêm vào body
                document.body.appendChild(notification);
                
                // Tự động xóa sau 3 giây
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            },
            
            // Advanced Search Methods
            toggleAdvancedSearch() {
                this.showAdvancedSearch = !this.showAdvancedSearch;
                if (!this.showAdvancedSearch) {
                    this.clearAdvancedFilter();
                }
            },
            
            getVisibleServices() {
                return this.menuServices.filter(service => service.visible);
            },
            
            async onFilterLayerChange() {
                if (!this.selectedFilterLayer) {
                    this.filterFields = [];
                    this.filterConditions = [];
                    return;
                }
                
                try {
                    // Find the selected service
                    const service = this.menuServices.find(s => s.id === this.selectedFilterLayer);
                    if (!service) return;
                    
                    // Get the first visible layer from the service
                    const visibleLayer = service.sublayers.find(layer => layer.visible);
                    if (!visibleLayer) {
                        alert('No visible layers found in the selected service');
                        return;
                    }
                    
                    // Get layer information to extract fields
                    const layerInfo = await this.getLayerInfo(service.url, visibleLayer.id);
                    if (layerInfo && layerInfo.fields) {
                        this.filterFields = layerInfo.fields.filter(field => 
                            field.name !== 'OBJECTID' && 
                            field.name !== 'objectid' && 
                            field.name !== 'SHAPE' && 
                            field.name !== 'shape' &&
                            field.name !== 'FID' &&
                            field.name !== 'fid' &&
                            field.name !== 'GlobalID' &&
                            field.name !== 'globalid'
                        );
                    } else {
                        this.filterFields = [];
                    }
                    
                    // Reset filter conditions
                    this.filterConditions = [];
                    
                } catch (error) {
                    console.error('Error loading filter fields:', error);
                    this.filterFields = [];
                }
            },
            
            addFilterCondition() {
                this.filterConditions.push({
                    field: '',
                    operator: '=',
                    value: ''
                });
            },
            
            removeFilterCondition(index) {
                this.filterConditions.splice(index, 1);
            },
            
            buildAdvancedWhereClause() {
                if (this.filterConditions.length === 0) {
                    return '1=1';
                }
                
                const conditions = this.filterConditions
                    .filter(condition => condition.field && condition.value)
                    .map(condition => {
                        const field = condition.field;
                        const operator = condition.operator;
                        const value = condition.value;
                        
                        // Handle different data types and operators
                        if (operator === 'LIKE' || operator === 'NOT LIKE') {
                            return `${field} ${operator} '%${value}%'`;
                        } else if (operator === 'IN' || operator === 'NOT IN') {
                            // Handle comma-separated values for IN clause
                            const values = value.split(',').map(v => `'${v.trim()}'`).join(',');
                            return `${field} ${operator} (${values})`;
                        } else {
                            // For numeric fields, don't quote the value
                            const fieldInfo = this.filterFields.find(f => f.name === field);
                            if (fieldInfo && this.isNumericType(fieldInfo.type)) {
                                return `${field} ${operator} ${value}`;
                            } else {
                                return `${field} ${operator} '${value}'`;
                            }
                        }
                    });
                
                return conditions.length > 0 ? conditions.join(' AND ') : '1=1';
            },
            
            isNumericType(type) {
                const numericTypes = ['esriFieldTypeInteger', 'esriFieldTypeSmallInteger', 'esriFieldTypeDouble', 'esriFieldTypeSingle'];
                return numericTypes.includes(type);
            },
            
            async applyAdvancedFilter() {
                if (!this.selectedFilterLayer || this.filterConditions.length === 0) {
                    alert('Please select a layer and add filter conditions');
                    return;
                }
                
                try {
                    this.featureSearchLoading = true;
                    this.advancedFilterActive = true;
                    
                    const service = this.menuServices.find(s => s.id === this.selectedFilterLayer);
                    const visibleLayer = service.sublayers.find(layer => layer.visible);
                    
                    if (!visibleLayer) {
                        alert('No visible layers found in the selected service');
                        return;
                    }
                    
                    const whereClause = this.buildAdvancedWhereClause();
                    console.log('Advanced filter WHERE clause:', whereClause);
                    
                    // Query features with the advanced filter
                    const response = await fetch(`${service.url}/${visibleLayer.id}/query?where=${encodeURIComponent(whereClause)}&outFields=*&f=json&token=${this.arcgisToken}`, {
                        headers: {
                            'Referer': window.location.origin
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch filtered features');
                    
                    const data = await response.json();
                    const features = data.features || [];
                    
                    // Convert to display format
                    const layerInfo = await this.getLayerInfo(service.url, visibleLayer.id);
                    const filteredFeatures = features.map(feature => {
                        const attributes = feature.attributes || {};
                        const objectid = attributes.objectid || attributes.OBJECTID || 'Unknown';
                        const displayName = this.getDisplayName(attributes, layerInfo?.fields || []);
                        
                        return {
                            objectid: objectid,
                            displayName: displayName,
                            attributes: attributes,
                            geometry: feature.geometry
                        };
                    });
                    
                    // Update search results with filtered features
                    this.featureSearchResults = [{
                        id: service.id,
                        name: service.name,
                        owner: service.owner,
                        url: service.url,
                        layers: [{
                            id: visibleLayer.id,
                            name: visibleLayer.name,
                            serviceName: service.name,
                            resources: filteredFeatures
                        }]
                    }];
                    
                    this.showSuccessMessage(`Found ${filteredFeatures.length} features matching the filter criteria`);
                    
                } catch (error) {
                    console.error('Error applying advanced filter:', error);
                    alert('Error applying filter: ' + error.message);
                } finally {
                    this.featureSearchLoading = false;
                }
            },
            
            clearAdvancedFilter() {
                this.selectedFilterLayer = '';
                this.filterFields = [];
                this.filterConditions = [];
                this.advancedFilterActive = false;
                
                // If there was a search query, re-run the normal search
                if (this.featureSearchQuery.trim()) {
                    this.searchFeatureResources();
                } else {
                    this.featureSearchResults = [];
                }
            },
            
            removeFeatureLayer(serviceId, layerId, objectId) {
                const layerKey = `${serviceId}_${layerId}_${objectId}`;
                if (this.listVectorLayer && this.listVectorLayer[layerKey]) {
                    this.listVectorLayer[layerKey].remove();
                    delete this.listVectorLayer[layerKey];
                    console.log(`Removed feature layer: ${layerKey}`);
                }
            }
        },
        mounted() {
            this.$nextTick(() => {
                this.initMap()
                this.getListLayer()
                this.validateToken()
                this.loadMenuFromStorage()
            })
        }
    })
    
    app.config.compilerOptions.delimiters = ['${', '}']
    app.mount('#app')
    
    // Make app available globally for HTML string function calls
    window.currentApp = app

        document.querySelectorAll('.filter-header').forEach(header => {
            header.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const content = document.getElementById(targetId);

                // Toggle expanded class
                content.classList.toggle('expanded');
                this.classList.toggle('expanded');

                // Close other sections
                document.querySelectorAll('.filter-content').forEach(el => {
                    if (el.id !== targetId) {
                        el.classList.remove('expanded');
                        el.previousElementSibling.classList.remove('expanded');
                    }
                });
            });
        });

</script>

</html>
