<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        /* Import Inter font for modern typography */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Global styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #374151;
            line-height: 1.6;
        }
        
        /* Header styles */
        .search-section {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .search-section h2 {
            color: #374151;
            font-weight: 600;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-card {
            background: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .filter-card .form-label {
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        /* Button styles */
        .btn-primary {
            background-color: rgb(37, 99, 235);
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: white;
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            background-color: rgb(29, 78, 216);
            color: white;
            transform: none;
            box-shadow: none;
        }
        
        .btn-primary i {
            color: white;
        }
        
        .search-btn {
            background-color: rgb(37, 99, 235);
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            font-size: 0.875rem;
            color: white;
        }
        
        .search-btn:hover {
            background-color: rgb(29, 78, 216);
            color: white;
            transform: none;
            box-shadow: none;
        }
        
        .search-btn i {
            color: white;
        }
        
        /* Card styles */
        .topic-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            margin-bottom: 1rem;
            background: white;
        }
        
        .topic-card:hover {
            transform: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .topic-type-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .type-bc-tin { 
            background: rgba(37, 99, 235, 0.1); 
            color: rgb(37, 99, 235); 
        }
        .type-dtcb { 
            background: rgba(37, 99, 235, 0.1); 
            color: rgb(37, 99, 235); 
        }
        .type-unknown { 
            background: rgba(37, 99, 235, 0.1); 
            color: rgb(37, 99, 235); 
        }
        
        /* Modal styles */
        .modal-content {
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            border-bottom: 1px solid #e5e7eb;
            padding: 1.5rem;
            background-color: #ffffff;
        }
        
        .modal-title {
            font-weight: 600;
            color: #374151;
            font-size: 1.125rem;
        }
        
        .modal-body {
            padding: 1.5rem;
            background-color: #ffffff;
        }
        
        .modal-footer {
            border-top: 1px solid #e5e7eb;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
        }
        
        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            opacity: 1;
        }
        
        .btn-close:hover {
            color: #374151;
        }
        
        /* Form styles */
        .form-control, .form-select {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            transition: border-color 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: rgb(37, 99, 235);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .form-label {
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        /* Stats cards */
        .stats-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .stats-card .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .stats-card div:last-child {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        /* Navigation styles */
        .navbar {
            background-color: #ffffff !important;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 0;
        }
        
        .navbar-brand {
            color: rgb(37, 99, 235) !important;
            font-weight: 600;
            font-size: 1.25rem;
        }
        
        .nav-link {
            color: #6b7280 !important;
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.5rem 1rem !important;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            color: #374151 !important;
            background-color: #f3f4f6;
        }
        
        .nav-link.active {
            color: rgb(37, 99, 235) !important;
            background-color: rgba(37, 99, 235, 0.1);
        }
        
        .nav-link.active i {
            color: rgb(37, 99, 235) !important;
        }
        
        /* Attachment styles */
        .attachment-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Badge styles */
        .badge {
            font-weight: 500;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .badge.bg-secondary {
            background-color: rgba(37, 99, 235, 0.1) !important;
            color: rgb(37, 99, 235) !important;
        }
        
        .badge.bg-info {
            background-color: rgba(37, 99, 235, 0.1) !important;
            color: rgb(37, 99, 235) !important;
        }
        
        /* Button variants */
        .btn-outline-primary {
            border-color: rgb(37, 99, 235);
            color: rgb(37, 99, 235);
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
            color: white;
        }
        
        .btn-outline-primary:hover i {
            color: white;
        }
        
        .btn-outline-warning {
            border-color: rgb(37, 99, 235);
            color: rgb(37, 99, 235);
            background-color: transparent;
        }
        
        .btn-outline-warning:hover {
            background-color: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
            color: white;
        }
        
        .btn-outline-warning:hover i {
            color: white;
        }
        
        .btn-outline-danger {
            border-color: rgb(37, 99, 235);
            color: rgb(37, 99, 235);
            background-color: transparent;
        }
        
        .btn-outline-danger:hover {
            background-color: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
            color: white;
        }
        
        .btn-outline-danger:hover i {
            color: white;
        }
        
        .btn-outline-info {
            border-color: rgb(37, 99, 235);
            color: rgb(37, 99, 235);
            background-color: transparent;
        }
        
        .btn-outline-info:hover {
            background-color: rgb(37, 99, 235);
            border-color: rgb(37, 99, 235);
            color: white;
        }
        
        .btn-outline-info:hover i {
            color: white;
        }
        
        /* Alert styles */
        .alert-info {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #374151;
        }
        
        /* Loading spinner */
        .spinner-border.text-primary {
            color: rgb(37, 99, 235) !important;
        }
        
        /* Card content styling */
        .card-body {
            padding: 1.5rem;
        }
        
        .card-title {
            font-weight: 600;
            color: #374151;
            font-size: 1.125rem;
            margin-bottom: 0.75rem;
        }
        
        .card-text {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        /* Container spacing */
        .container {
            max-width: 1200px;
        }
        
        /* Section spacing */
        section {
            margin-bottom: 2rem;
        }
        
        /* Text styling */
        h1, h2, h3, h4, h5, h6 {
            color: #374151;
            font-weight: 600;
        }
        
        /* Icon styling */
        .fas, .far, .fab {
            color: #6b7280;
        }
        
        /* Icons inside blue buttons should be white */
        .btn-primary i,
        .search-btn i,
        .btn-outline-primary:hover i,
        .btn-outline-warning:hover i,
        .btn-outline-danger:hover i,
        .btn-outline-info:hover i {
            color: white !important;
        }
        
        /* Button sizing */
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }
        
        /* Input placeholder styling */
        .form-control::placeholder {
            color: #9ca3af;
            font-size: 0.875rem;
        }
        
        /* Focus states */
        .btn:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        /* Hover effects */
        .btn:hover {
            transition: all 0.2s ease;
        }
        
        /* Text colors */
        .text-muted {
            color: #6b7280 !important;
        }
        
        /* Border utilities */
        .border {
            border-color: #e5e7eb !important;
        }

        /* Gallery Styles */
        .attachments-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .attachment-gallery-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .attachment-gallery-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .attachment-gallery-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .attachment-gallery-item img:hover {
            opacity: 0.8;
        }

        .attachment-gallery-item video {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .attachment-gallery-item audio {
            width: 100%;
        }

        .attachment-gallery-item .file-icon {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e9ecef;
            border-radius: 4px;
        }

        .attachment-gallery-item .file-icon i {
            font-size: 2em;
            color: #6c757d;
        }

        /* Media Thumbnail Styles */
        .media-thumbnail {
            position: relative;
            cursor: pointer;
            border-radius: 4px;
            overflow: hidden;
            height: 80px;
            background: #f8f9fa;
        }

        .media-thumbnail img,
        .media-thumbnail video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .media-thumbnail:hover img,
        .media-thumbnail:hover video {
            transform: scale(1.05);
        }

        .media-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .media-thumbnail:hover .media-overlay {
            opacity: 1;
        }

        .media-overlay i {
            color: white;
            font-size: 1.5em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .audio-thumbnail {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .audio-thumbnail i {
            font-size: 2em;
        }

        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Preview Modal Styles */
        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
        }

        .preview-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .preview-modal-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-map-marked-alt me-2"></i>Web Map Service
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-2"></i>Home
                </a>
                <a class="nav-link active" href="/topics">
                    <i class="fas fa-list me-2"></i>Topics
                </a>
                <a class="nav-link" href="/draw">
                    <i class="fas fa-pen me-2"></i>Draw
                </a>
                <a class="nav-link" href="/compare">
                    <i class="fas fa-balance-scale me-2"></i>Compare
                </a>
                <button id="loginBtn" class="nav-link btn btn-link" style="background: none; border: none; color: inherit;">
                    <i class="fas fa-user me-2"></i>Đăng nhập
                </button>
            </div>
        </div>
    </nav>

    <!-- Login Modal -->
    <div id="loginModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Đăng nhập</h5>
                    <button type="button" class="btn-close" id="closeLoginModal" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm" method="post" action="/accounts/login/">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="username" class="form-label">Tên đăng nhập</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Đăng nhập</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <section class="search-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">
                        <i class="fas fa-search me-2"></i>Topic Management
                    </h2>
                    <div class="filter-card">
                        <form id="searchForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Topic Name</label>
                                    <input type="text" class="form-control" id="searchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Created Date From</label>
                                    <input type="text" class="form-control datepicker" id="searchDateFrom" placeholder="Select date...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Created Date To</label>
                                    <input type="text" class="form-control datepicker" id="searchDateTo" placeholder="Select date...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="searchType">
                                        <option value="">All Types</option>
                                        <option value="BC_tin">BC tin</option>
                                        <option value="Thong_tin_DTCB">Thông tin ĐTCB</option>
                                        <option value="Chua_xac_dinh">Chưa xác định</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="searchSubject" placeholder="Search by subject...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Area</label>
                                    <input type="text" class="form-control" id="searchArea" placeholder="Search by area...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Content</label>
                                    <input type="text" class="form-control" id="searchContent" placeholder="Search in content...">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn search-btn w-100">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalTopics">0</div>
                    <div>Total Topics</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAttachments">0</div>
                    <div>Total Attachments</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="bcTinCount">0</div>
                    <div>BC tin</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="dtcbCount">0</div>
                    <div>Thông tin ĐTCB</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="container mb-4">
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#topicModal" onclick="openCreateModal()">
                    <i class="fas fa-plus me-2"></i>Create New Topic
                </button>
            </div>
        </div>
    </div>

    <!-- Topics List -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div id="topicsList">
                    <!-- Topics will be loaded here -->
                </div>
                <div id="loadingSpinner" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="noResults" class="text-center d-none">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No topics found matching your search criteria.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Modal -->
    <div class="modal fade" id="topicModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topicModalTitle">Create New Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="topicForm">
                        <input type="hidden" id="topicId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Topic Name *</label>
                                <input type="text" class="form-control" id="topicName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type *</label>
                                <select class="form-select" id="topicType" required>
                                    <option value="BC_tin">BC tin</option>
                                    <option value="Thong_tin_DTCB">Thông tin ĐTCB</option>
                                    <option value="Chua_xac_dinh">Chưa xác định</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Area *</label>
                                <input type="text" class="form-control" id="topicArea" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Subject *</label>
                                <input type="text" class="form-control" id="topicSubject" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Content *</label>
                                <textarea class="form-control" id="topicContent" rows="4" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Attachments</label>
                                <input type="file" class="form-control" id="topicAttachments" multiple>
                                <div id="attachmentsList" class="mt-2">
                                    <!-- Existing attachments will be shown here -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTopic()">Save Topic</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Topic Modal -->
    <div class="modal fade" id="viewTopicModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Topic Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewTopicContent">
                    <!-- Topic details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentTopic()">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Global variables
        let currentTopics = [];
        let currentTopicId = null;
        const API_BASE = '/api/topics/';

        // Initialize date pickers
        document.addEventListener('DOMContentLoaded', function() {
            flatpickr(".datepicker", {
                dateFormat: "Y-m-d",
                allowInput: true
            });
            
            loadTopics();
            loadStats();
        });

        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            searchTopics();
        });

        // Load all topics
        async function loadTopics() {
            showLoading(true);
            try {
                const response = await axios.get(API_BASE, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                currentTopics = response.data;
                displayTopics(currentTopics);
                showLoading(false);
            } catch (error) {
                console.error('Error loading topics:', error);
                showLoading(false);
                showError('Failed to load topics');
            }
        }

        // Search topics with filters
        async function searchTopics() {
            showLoading(true);
            const searchParams = new URLSearchParams();
            
            const name = document.getElementById('searchName').value;
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            const type = document.getElementById('searchType').value;
            const subject = document.getElementById('searchSubject').value;
            const area = document.getElementById('searchArea').value;
            const content = document.getElementById('searchContent').value;

            if (name) searchParams.append('name', name);
            if (dateFrom) searchParams.append('created_date_from', dateFrom);
            if (dateTo) searchParams.append('created_date_to', dateTo);
            if (type) searchParams.append('type', type);
            if (subject) searchParams.append('subject', subject);
            if (area) searchParams.append('area', area);
            if (content) searchParams.append('content', content);

            try {
                const response = await axios.get(`${API_BASE}search/?${searchParams.toString()}`, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                currentTopics = response.data;
                displayTopics(currentTopics);
                showLoading(false);
            } catch (error) {
                console.error('Error searching topics:', error);
                showLoading(false);
                showError('Failed to search topics');
            }
        }

        // Display topics in the list
        function displayTopics(topics) {
            const topicsList = document.getElementById('topicsList');
            const noResults = document.getElementById('noResults');

            if (topics.length === 0) {
                topicsList.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            }

            noResults.classList.add('d-none');
            topicsList.innerHTML = topics.map(topic => `
                <div class="card topic-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title mb-2">${topic.topic_name}</h5>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="topic-type-badge type-${getTypeClass(topic.type)}">${getTypeLabel(topic.type)}</span>
                                    <span class="badge bg-secondary">${topic.subject}</span>
                                    <span class="badge bg-info">${topic.area}</span>
                                </div>
                                <p class="card-text text-muted mb-1">
                                    <i class="fas fa-calendar me-2"></i>${formatDate(topic.created_date)}
                                </p>
                                <p class="card-text text-muted mb-0">
                                    <i class="fas fa-user me-2"></i>${topic.created_by || 'Unknown'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="viewTopic('${topic.id}')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <button class="btn btn-outline-warning btn-sm me-2" onclick="editTopic('${topic.id}')">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTopic('${topic.id}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get type class for styling
        function getTypeClass(type) {
            switch(type) {
                case 'BC_tin': return 'bc-tin';
                case 'Thong_tin_DTCB': return 'dtcb';
                case 'Chua_xac_dinh': return 'unknown';
                default: return 'unknown';
            }
        }

        // Get type label
        function getTypeLabel(type) {
            switch(type) {
                case 'BC_tin': return 'BC tin';
                case 'Thong_tin_DTCB': return 'Thông tin ĐTCB';
                case 'Chua_xac_dinh': return 'Chưa xác định';
                default: return type;
            }
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load topic statistics
        async function loadStats() {
            try {
                const response = await axios.get(API_BASE, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                const topics = response.data;
                
                document.getElementById('totalTopics').textContent = topics.length;
                
                let totalAttachments = 0;
                let bcTinCount = 0;
                let dtcbCount = 0;
                
                topics.forEach(topic => {
                    totalAttachments += topic.attachments ? topic.attachments.length : 0;
                    if (topic.type === 'BC_tin') bcTinCount++;
                    if (topic.type === 'Thong_tin_DTCB') dtcbCount++;
                });
                
                document.getElementById('totalAttachments').textContent = totalAttachments;
                document.getElementById('bcTinCount').textContent = bcTinCount;
                document.getElementById('dtcbCount').textContent = dtcbCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Open create modal
        function openCreateModal() {
            currentTopicId = null;
            document.getElementById('topicModalTitle').textContent = 'Create New Topic';
            document.getElementById('topicForm').reset();
            document.getElementById('attachmentsList').innerHTML = '';
        }

        // Edit topic
        async function editTopic(topicId) {
            try {
                const response = await axios.get(`${API_BASE}${topicId}/`, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                const topic = response.data;
                
                currentTopicId = topicId;
                document.getElementById('topicModalTitle').textContent = 'Edit Topic';
                document.getElementById('topicId').value = topic.id;
                document.getElementById('topicName').value = topic.topic_name;
                document.getElementById('topicType').value = topic.type;
                document.getElementById('topicArea').value = topic.area;
                document.getElementById('topicSubject').value = topic.subject;
                document.getElementById('topicContent').value = topic.content;
                
                // Display existing attachments
                displayAttachments(topic.attachments || []);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('topicModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading topic:', error);
                showError('Failed to load topic for editing');
            }
        }

        // View topic
        async function viewTopic(topicId) {
            try {
                const response = await axios.get(`${API_BASE}${topicId}/`, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                const topic = response.data;
                
                currentTopicId = topicId;
                const viewContent = document.getElementById('viewTopicContent');
                
                viewContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Topic Name</h6>
                            <p class="mb-3">${topic.topic_name}</p>
                            
                            <h6>Type</h6>
                            <p class="mb-3"><span class="topic-type-badge type-${getTypeClass(topic.type)}">${getTypeLabel(topic.type)}</span></p>
                            
                            <h6>Area</h6>
                            <p class="mb-3">${topic.area}</p>
                            
                            <h6>Subject</h6>
                            <p class="mb-3">${topic.subject}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Created Date</h6>
                            <p class="mb-3">${formatDate(topic.created_date)}</p>
                            
                            <h6>Created By</h6>
                            <p class="mb-3">${topic.created_by_username || 'Unknown'}</p>
                            
                            <h6>Last Updated</h6>
                            <p class="mb-3">${formatDate(topic.updated_at)}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Content</h6>
                            <p class="mb-3">${topic.content}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Attachments (${topic.attachments ? topic.attachments.length : 0})</h6>
                            ${topic.attachments && topic.attachments.length > 0 ? 
                                `<div class="attachments-gallery">
                                    ${topic.attachments.map(att => createAttachmentGalleryItem(att)).join('')}
                                </div>` : 
                                '<p class="text-muted">No attachments</p>'
                            }
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('viewTopicModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading topic:', error);
                showError('Failed to load topic details');
            }
        }

        // Edit current topic (from view modal)
        function editCurrentTopic() {
            bootstrap.Modal.getInstance(document.getElementById('viewTopicModal')).hide();
            editTopic(currentTopicId);
        }

        // Display attachments in edit modal
        function displayAttachments(attachments) {
            const attachmentsList = document.getElementById('attachmentsList');
            
            if (attachments.length === 0) {
                attachmentsList.innerHTML = '<p class="text-muted">No attachments</p>';
                return;
            }
            
            attachmentsList.innerHTML = `
                <div class="attachments-gallery">
                    ${attachments.map(att => createAttachmentGalleryItemForEdit(att)).join('')}
                </div>
            `;
        }

        // Create attachment gallery item for edit modal
        function createAttachmentGalleryItemForEdit(attachment) {
            // Determine content type from file extension since API doesn't provide content_type
            const contentType = getContentTypeFromFilename(attachment.filename);
            const isImage = contentType && contentType.startsWith('image/');
            const isVideo = contentType && contentType.startsWith('video/');
            const isAudio = contentType && contentType.startsWith('audio/');
            
            let mediaContent = '';
            let isMediaFile = isImage || isVideo || isAudio;
            
            if (isImage) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <img src="${attachment.file}" 
                             alt="${attachment.filename}" 
                             class="preview-img">
                        <div class="media-overlay">
                            <i class="fas fa-eye"></i>
                        </div>
                    </div>
                `;
            } else if (isVideo) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <video class="video-thumbnail">
                            <source src="${attachment.file}" type="${contentType}">
                        </video>
                        <div class="media-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else if (isAudio) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <div class="audio-thumbnail">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="media-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else {
                mediaContent = `
                    <div class="file-icon" style="margin-bottom: 8px;">
                        <i class="fas fa-file"></i>
                    </div>
                `;
            }
            
            return `
                <div class="attachment-gallery-item">
                    ${mediaContent}
                    <div class="attachment-info">
                        <div class="attachment-name" style="font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; word-break: break-word;">
                            ${attachment.filename}
                        </div>
                        <div class="attachment-size" style="font-size: 0.8rem; color: #6c757d; margin-bottom: 8px;">
                            ${formatFileSize(attachment.file_size)}
                        </div>
                        <div class="attachment-actions" style="display: flex; gap: 5px; justify-content: center;">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAttachment('${attachment.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            ${isMediaFile ? `
                                <button class="btn btn-sm btn-outline-info" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Create attachment gallery item
        function createAttachmentGalleryItem(attachment) {
            // Determine content type from file extension since API doesn't provide content_type
            const contentType = getContentTypeFromFilename(attachment.filename);
            const isImage = contentType && contentType.startsWith('image/');
            const isVideo = contentType && contentType.startsWith('video/');
            const isAudio = contentType && contentType.startsWith('audio/');
            
            let mediaContent = '';
            let isMediaFile = isImage || isVideo || isAudio;
            
            if (isImage) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <img src="${attachment.file}" 
                             alt="${attachment.filename}" 
                             class="preview-img">
                        <div class="media-overlay">
                            <i class="fas fa-eye"></i>
                        </div>
                    </div>
                `;
            } else if (isVideo) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <video class="video-thumbnail">
                            <source src="${attachment.file}" type="${contentType}">
                        </video>
                        <div class="media-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else if (isAudio) {
                mediaContent = `
                    <div class="media-thumbnail" style="margin-bottom: 8px;" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                        <div class="audio-thumbnail">
                            <i class="fas fa-music"></i>
                        </div>
                        <div class="media-overlay">
                            <i class="fas fa-play"></i>
                        </div>
                    </div>
                `;
            } else {
                mediaContent = `
                    <div class="file-icon" style="margin-bottom: 8px;">
                        <i class="fas fa-file"></i>
                    </div>
                `;
            }
            
            return `
                <div class="attachment-gallery-item">
                    ${mediaContent}
                    <div class="attachment-info">
                        <div class="attachment-name" style="font-size: 0.9rem; font-weight: 500; margin-bottom: 4px; word-break: break-word;">
                            ${attachment.filename}
                        </div>
                        <div class="attachment-size" style="font-size: 0.8rem; color: #6c757d; margin-bottom: 8px;">
                            ${formatFileSize(attachment.file_size)}
                        </div>
                        <div class="attachment-actions" style="display: flex; gap: 5px; justify-content: center;">
                            <button class="btn btn-sm btn-outline-primary download-btn" onclick="downloadAttachment('${attachment.id}')">
                                <i class="fas fa-download"></i>
                            </button>
                            ${isMediaFile ? `
                                <button class="btn btn-sm btn-outline-info" onclick="previewAttachment('${attachment.id}', '${attachment.filename}', '${contentType}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get attachment URL
        function getAttachmentUrl(attachmentId) {
            return `${API_BASE}attachments/${attachmentId}/`;
        }

        // Get content type from filename
        function getContentTypeFromFilename(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                // Images
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'gif': 'image/gif',
                'bmp': 'image/bmp',
                'webp': 'image/webp',
                'svg': 'image/svg+xml',
                'ico': 'image/x-icon',
                
                // Videos
                'mp4': 'video/mp4',
                'avi': 'video/x-msvideo',
                'mov': 'video/quicktime',
                'wmv': 'video/x-ms-wmv',
                'flv': 'video/x-flv',
                'webm': 'video/webm',
                'mkv': 'video/x-matroska',
                '3gp': 'video/3gpp',
                
                // Audio
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'ogg': 'audio/ogg',
                'aac': 'audio/aac',
                'flac': 'audio/flac',
                'm4a': 'audio/mp4',
                'wma': 'audio/x-ms-wma',
                
                // Documents
                'pdf': 'application/pdf',
                'doc': 'application/msword',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'xls': 'application/vnd.ms-excel',
                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'ppt': 'application/vnd.ms-powerpoint',
                'pptx': 'application/vnd.openxmlformats-officedocument.presentationml.presentation',
                'txt': 'text/plain',
                'rtf': 'application/rtf',
                
                // Archives
                'zip': 'application/zip',
                'rar': 'application/x-rar-compressed',
                '7z': 'application/x-7z-compressed',
                'tar': 'application/x-tar',
                'gz': 'application/gzip'
            };
            
            return mimeTypes[extension] || 'application/octet-stream';
        }

        // Preview attachment
        function previewAttachment(attachmentId, fileName, contentType) {
            // Find the attachment object to get the direct file URL
            let url = getAttachmentUrl(attachmentId);
            
            // Try to find the attachment in current topics to get the direct file URL
            for (let topic of currentTopics) {
                if (topic.attachments) {
                    for (let att of topic.attachments) {
                        if (att.id === attachmentId) {
                            url = att.file;
                            break;
                        }
                    }
                }
            }
            
            // Create modal for preview
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'preview-modal-content';
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'preview-modal-close';
            closeBtn.innerHTML = '×';
            closeBtn.onclick = () => document.body.removeChild(modal);
            
            const title = document.createElement('h3');
            title.textContent = fileName;
            title.style.marginBottom = '15px';
            
            let mediaElement = '';
            
            if (contentType.startsWith('image/')) {
                mediaElement = `
                    <div style="text-align: center;">
                        <img src="${url}" style="max-width: 100%; max-height: 70vh; object-fit: contain; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    </div>
                `;
            } else if (contentType.startsWith('video/')) {
                mediaElement = `
                    <div style="text-align: center;">
                        <video controls style="max-width: 100%; max-height: 70vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <source src="${url}" type="${contentType}">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                `;
            } else if (contentType.startsWith('audio/')) {
                mediaElement = `
                    <div style="text-align: center; padding: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px; border-radius: 8px; margin-bottom: 20px;">
                            <i class="fas fa-music" style="font-size: 4em; color: white;"></i>
                        </div>
                        <audio controls style="width: 100%; max-width: 400px;">
                            <source src="${url}" type="${contentType}">
                            Your browser does not support the audio tag.
                        </audio>
                    </div>
                `;
            } else {
                mediaElement = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file" style="font-size: 3em; color: #6c757d;"></i>
                        <p>Preview not available for this file type</p>
                        <a href="${url}" download="${fileName}" class="btn btn-primary">Download File</a>
                    </div>
                `;
            }
            
            modalContent.innerHTML = `
                ${closeBtn.outerHTML}
                ${title.outerHTML}
                ${mediaElement}
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            };
        }

        // Save topic (create or update)
        async function saveTopic() {
            const form = document.getElementById('topicForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData();
            formData.append('topic_name', document.getElementById('topicName').value);
            formData.append('type', document.getElementById('topicType').value);
            formData.append('area', document.getElementById('topicArea').value);
            formData.append('subject', document.getElementById('topicSubject').value);
            formData.append('content', document.getElementById('topicContent').value);

            const attachmentsInput = document.getElementById('topicAttachments');
            if (attachmentsInput.files.length > 0) {
                for (let file of attachmentsInput.files) {
                    formData.append('attachments', file);
                }
            }

            try {
                if (currentTopicId) {
                    // Update existing topic
                    await axios.patch(`${API_BASE}${currentTopicId}/`, formData, {
                        headers: { 
                            'Content-Type': 'multipart/form-data',
                            'X-CSRFToken': getCSRFToken()
                        }
                    });
                    showSuccess('Topic updated successfully');
                } else {
                    // Create new topic
                    await axios.post(API_BASE, formData, {
                        headers: { 
                            'Content-Type': 'multipart/form-data',
                            'X-CSRFToken': getCSRFToken()
                        }
                    });
                    showSuccess('Topic created successfully');
                }

                // Close modal and refresh
                bootstrap.Modal.getInstance(document.getElementById('topicModal')).hide();
                loadTopics();
                loadStats();
            } catch (error) {
                console.error('Error saving topic:', error);
                showError('Failed to save topic');
            }
        }

        // Delete topic
        async function deleteTopic(topicId) {
            if (!confirm('Are you sure you want to delete this topic? This action cannot be undone.')) {
                return;
            }

            try {
                await axios.delete(`${API_BASE}${topicId}/`, {
                    headers: { 'X-CSRFToken': getCSRFToken() }
                });
                showSuccess('Topic deleted successfully');
                loadTopics();
                loadStats();
            } catch (error) {
                console.error('Error deleting topic:', error);
                showError('Failed to delete topic');
            }
        }

        // Remove attachment
        async function removeAttachment(attachmentId) {
            if (!confirm('Are you sure you want to remove this attachment?')) {
                return;
            }

            try {
                await axios.delete(`${API_BASE}${currentTopicId}/remove_attachment/`, {
                    headers: { 'X-CSRFToken': getCSRFToken() },
                    data: { attachment_id: attachmentId }
                });
                showSuccess('Attachment removed successfully');
                // Refresh the topic data
                editTopic(currentTopicId);
            } catch (error) {
                console.error('Error removing attachment:', error);
                showError('Failed to remove attachment');
            }
        }

        // Download attachment
        async function downloadAttachment(attachmentId) {
            try {
                // Find the attachment object to get the direct file URL and filename
                let fileUrl = `${API_BASE}attachments/${attachmentId}/`;
                let filename = 'attachment';
                
                for (let topic of currentTopics) {
                    if (topic.attachments) {
                        for (let att of topic.attachments) {
                            if (att.id === attachmentId) {
                                fileUrl = att.file;
                                filename = att.filename;
                                break;
                            }
                        }
                    }
                }
                
                // Create a temporary link to download the file
                const link = document.createElement('a');
                link.href = fileUrl;
                link.setAttribute('download', filename);
                link.setAttribute('target', '_blank');
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (error) {
                console.error('Error downloading attachment:', error);
                showError('Failed to download attachment');
            }
        }

        // Utility functions
        function getCSRFToken() {
            // Try to get from cookie first
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    return value;
                }
            }
            // Fallback to DOM if cookie not found
            const tokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenElement) {
                return tokenElement.value;
            }
            // If still not found, try to get from meta tag
            const metaToken = document.querySelector('meta[name=csrf-token]');
            if (metaToken) {
                return metaToken.getAttribute('content');
            }
            throw new Error('CSRF token not found');
        }
        
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        function showSuccess(message) {
            // You can implement a toast notification here
            alert(message);
        }

        function showError(message) {
            // You can implement a toast notification here
            alert('Error: ' + message);
        }

        // Login Modal Functionality
        const loginModal = document.getElementById('loginModal');
        const loginBtn = document.getElementById('loginBtn');
        const closeLoginModal = document.getElementById('closeLoginModal');

        loginBtn.addEventListener('click', function() {
            const modal = new bootstrap.Modal(loginModal);
            modal.show();
        });

        closeLoginModal.addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(loginModal);
            modal.hide();
        });

        // Handle login form submission
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            fetch('/api/auth/login/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Đăng nhập thành công!');
                    bootstrap.Modal.getInstance(loginModal).hide();
                    // Reload page to update login state
                    window.location.reload();
                } else if (data.error) {
                    alert('Đăng nhập thất bại: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đăng nhập.');
            });
        });

        // Function to update login state
        function updateLoginState(isLoggedIn, user = null) {
            const loginBtn = document.getElementById('loginBtn');
            if (isLoggedIn && user) {
                loginBtn.innerHTML = `<i class="fas fa-user me-2"></i>${user.username}`;
                loginBtn.onclick = function() {
                    // Show user menu or logout
                    if (confirm('Bạn có muốn đăng xuất?')) {
                        logout();
                    }
                };
            } else {
                loginBtn.innerHTML = `<i class="fas fa-user me-2"></i>Đăng nhập`;
                loginBtn.onclick = function() {
                    const modal = new bootstrap.Modal(loginModal);
                    modal.show();
                };
            }
        }

        // Logout function
        function logout() {
            fetch('/api/auth/logout/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert('Đăng xuất thành công!');
                    updateLoginState(false);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi đăng xuất.');
            });
        }

        // Check if user is already logged in
        fetch('/api/auth/user/', {
            headers: { 'X-CSRFToken': getCSRFToken() }
        })
            .then(response => response.json())
            .then(data => {
                if (data.user) {
                    updateLoginState(true, data.user);
                }
            })
            .catch(error => {
                console.log('User not logged in');
            });
    </script>
</body>
</html>
