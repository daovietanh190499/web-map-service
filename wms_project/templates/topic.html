<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topic Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        .search-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .filter-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .topic-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .topic-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .topic-type-badge {
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .type-bc-tin { background: #e3f2fd; color: #1976d2; }
        .type-dtcb { background: #f3e5f5; color: #7b1fa2; }
        .type-unknown { background: #fff3e0; color: #f57c00; }
        .modal-content {
            border-radius: 15px;
            border: none;
        }
        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 0.75rem 1rem;
        }
        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .attachment-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 600;
        }
        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-map-marked-alt me-2"></i>Web Map Service
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/topics">Topics</a>
                <a class="nav-link" href="/draw">Draw</a>
                <a class="nav-link" href="/compare">Compare</a>
            </div>
        </div>
    </nav>

    <!-- Search Section -->
    <section class="search-section">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h2 class="text-center mb-4">
                        <i class="fas fa-search me-2"></i>Topic Management
                    </h2>
                    <div class="filter-card">
                        <form id="searchForm">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label text-white">Topic Name</label>
                                    <input type="text" class="form-control" id="searchName" placeholder="Search by name...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Created Date From</label>
                                    <input type="text" class="form-control datepicker" id="searchDateFrom" placeholder="Select date...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Created Date To</label>
                                    <input type="text" class="form-control datepicker" id="searchDateTo" placeholder="Select date...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Type</label>
                                    <select class="form-select" id="searchType">
                                        <option value="">All Types</option>
                                        <option value="BC_tin">BC tin</option>
                                        <option value="Thong_tin_DTCB">Thông tin ĐTCB</option>
                                        <option value="Chua_xac_dinh">Chưa xác định</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Subject</label>
                                    <input type="text" class="form-control" id="searchSubject" placeholder="Search by subject...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Area</label>
                                    <input type="text" class="form-control" id="searchArea" placeholder="Search by area...">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-white">Content</label>
                                    <input type="text" class="form-control" id="searchContent" placeholder="Search in content...">
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn search-btn w-100">
                                        <i class="fas fa-search me-2"></i>Search
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalTopics">0</div>
                    <div>Total Topics</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalAttachments">0</div>
                    <div>Total Attachments</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="bcTinCount">0</div>
                    <div>BC tin</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="dtcbCount">0</div>
                    <div>Thông tin ĐTCB</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions Section -->
    <div class="container mb-4">
        <div class="row">
            <div class="col-12">
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#topicModal" onclick="openCreateModal()">
                    <i class="fas fa-plus me-2"></i>Create New Topic
                </button>
            </div>
        </div>
    </div>

    <!-- Topics List -->
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div id="topicsList">
                    <!-- Topics will be loaded here -->
                </div>
                <div id="loadingSpinner" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="noResults" class="text-center d-none">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No topics found matching your search criteria.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Modal -->
    <div class="modal fade" id="topicModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topicModalTitle">Create New Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="topicForm">
                        <input type="hidden" id="topicId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Topic Name *</label>
                                <input type="text" class="form-control" id="topicName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Type *</label>
                                <select class="form-select" id="topicType" required>
                                    <option value="BC_tin">BC tin</option>
                                    <option value="Thong_tin_DTCB">Thông tin ĐTCB</option>
                                    <option value="Chua_xac_dinh">Chưa xác định</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Area *</label>
                                <input type="text" class="form-control" id="topicArea" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Subject *</label>
                                <input type="text" class="form-control" id="topicSubject" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Content *</label>
                                <textarea class="form-control" id="topicContent" rows="4" required></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Attachments</label>
                                <input type="file" class="form-control" id="topicAttachments" multiple>
                                <div id="attachmentsList" class="mt-2">
                                    <!-- Existing attachments will be shown here -->
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTopic()">Save Topic</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Topic Modal -->
    <div class="modal fade" id="viewTopicModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Topic Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="viewTopicContent">
                    <!-- Topic details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="editCurrentTopic()">Edit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Global variables
        let currentTopics = [];
        let currentTopicId = null;
        const API_BASE = '/api/topics/';

        // Initialize date pickers
        document.addEventListener('DOMContentLoaded', function() {
            flatpickr(".datepicker", {
                dateFormat: "Y-m-d",
                allowInput: true
            });
            
            loadTopics();
            loadStats();
        });

        // Search form handler
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            searchTopics();
        });

        // Load all topics
        async function loadTopics() {
            showLoading(true);
            try {
                const response = await axios.get(API_BASE);
                currentTopics = response.data;
                displayTopics(currentTopics);
                showLoading(false);
            } catch (error) {
                console.error('Error loading topics:', error);
                showLoading(false);
                showError('Failed to load topics');
            }
        }

        // Search topics with filters
        async function searchTopics() {
            showLoading(true);
            const searchParams = new URLSearchParams();
            
            const name = document.getElementById('searchName').value;
            const dateFrom = document.getElementById('searchDateFrom').value;
            const dateTo = document.getElementById('searchDateTo').value;
            const type = document.getElementById('searchType').value;
            const subject = document.getElementById('searchSubject').value;
            const area = document.getElementById('searchArea').value;
            const content = document.getElementById('searchContent').value;

            if (name) searchParams.append('name', name);
            if (dateFrom) searchParams.append('created_date_from', dateFrom);
            if (dateTo) searchParams.append('created_date_to', dateTo);
            if (type) searchParams.append('type', type);
            if (subject) searchParams.append('subject', subject);
            if (area) searchParams.append('area', area);
            if (content) searchParams.append('content', content);

            try {
                const response = await axios.get(`${API_BASE}search/?${searchParams.toString()}`);
                currentTopics = response.data;
                displayTopics(currentTopics);
                showLoading(false);
            } catch (error) {
                console.error('Error searching topics:', error);
                showLoading(false);
                showError('Failed to search topics');
            }
        }

        // Display topics in the list
        function displayTopics(topics) {
            const topicsList = document.getElementById('topicsList');
            const noResults = document.getElementById('noResults');

            if (topics.length === 0) {
                topicsList.innerHTML = '';
                noResults.classList.remove('d-none');
                return;
            }

            noResults.classList.add('d-none');
            topicsList.innerHTML = topics.map(topic => `
                <div class="card topic-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title mb-2">${topic.topic_name}</h5>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="topic-type-badge type-${getTypeClass(topic.type)}">${getTypeLabel(topic.type)}</span>
                                    <span class="badge bg-secondary">${topic.subject}</span>
                                    <span class="badge bg-info">${topic.area}</span>
                                </div>
                                <p class="card-text text-muted mb-1">
                                    <i class="fas fa-calendar me-2"></i>${formatDate(topic.created_date)}
                                </p>
                                <p class="card-text text-muted mb-0">
                                    <i class="fas fa-user me-2"></i>${topic.created_by || 'Unknown'}
                                </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="viewTopic('${topic.id}')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <button class="btn btn-outline-warning btn-sm me-2" onclick="editTopic('${topic.id}')">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteTopic('${topic.id}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get type class for styling
        function getTypeClass(type) {
            switch(type) {
                case 'BC_tin': return 'bc-tin';
                case 'Thong_tin_DTCB': return 'dtcb';
                case 'Chua_xac_dinh': return 'unknown';
                default: return 'unknown';
            }
        }

        // Get type label
        function getTypeLabel(type) {
            switch(type) {
                case 'BC_tin': return 'BC tin';
                case 'Thong_tin_DTCB': return 'Thông tin ĐTCB';
                case 'Chua_xac_dinh': return 'Chưa xác định';
                default: return type;
            }
        }

        // Format date
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load topic statistics
        async function loadStats() {
            try {
                const response = await axios.get(API_BASE);
                const topics = response.data;
                
                document.getElementById('totalTopics').textContent = topics.length;
                
                let totalAttachments = 0;
                let bcTinCount = 0;
                let dtcbCount = 0;
                
                topics.forEach(topic => {
                    totalAttachments += topic.attachments ? topic.attachments.length : 0;
                    if (topic.type === 'BC_tin') bcTinCount++;
                    if (topic.type === 'Thong_tin_DTCB') dtcbCount++;
                });
                
                document.getElementById('totalAttachments').textContent = totalAttachments;
                document.getElementById('bcTinCount').textContent = bcTinCount;
                document.getElementById('dtcbCount').textContent = dtcbCount;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Open create modal
        function openCreateModal() {
            currentTopicId = null;
            document.getElementById('topicModalTitle').textContent = 'Create New Topic';
            document.getElementById('topicForm').reset();
            document.getElementById('attachmentsList').innerHTML = '';
        }

        // Edit topic
        async function editTopic(topicId) {
            try {
                const response = await axios.get(`${API_BASE}${topicId}/`);
                const topic = response.data;
                
                currentTopicId = topicId;
                document.getElementById('topicModalTitle').textContent = 'Edit Topic';
                document.getElementById('topicId').value = topic.id;
                document.getElementById('topicName').value = topic.topic_name;
                document.getElementById('topicType').value = topic.type;
                document.getElementById('topicArea').value = topic.area;
                document.getElementById('topicSubject').value = topic.subject;
                document.getElementById('topicContent').value = topic.content;
                
                // Display existing attachments
                displayAttachments(topic.attachments || []);
                
                // Show modal
                const modal = new bootstrap.Modal(document.getElementById('topicModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading topic:', error);
                showError('Failed to load topic for editing');
            }
        }

        // View topic
        async function viewTopic(topicId) {
            try {
                const response = await axios.get(`${API_BASE}${topicId}/`);
                const topic = response.data;
                
                currentTopicId = topicId;
                const viewContent = document.getElementById('viewTopicContent');
                
                viewContent.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Topic Name</h6>
                            <p class="mb-3">${topic.topic_name}</p>
                            
                            <h6>Type</h6>
                            <p class="mb-3"><span class="topic-type-badge type-${getTypeClass(topic.type)}">${getTypeLabel(topic.type)}</span></p>
                            
                            <h6>Area</h6>
                            <p class="mb-3">${topic.area}</p>
                            
                            <h6>Subject</h6>
                            <p class="mb-3">${topic.subject}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Created Date</h6>
                            <p class="mb-3">${formatDate(topic.created_date)}</p>
                            
                            <h6>Created By</h6>
                            <p class="mb-3">${topic.created_by_username || 'Unknown'}</p>
                            
                            <h6>Last Updated</h6>
                            <p class="mb-3">${formatDate(topic.updated_at)}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Content</h6>
                            <p class="mb-3">${topic.content}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Attachments (${topic.attachments ? topic.attachments.length : 0})</h6>
                            ${topic.attachments && topic.attachments.length > 0 ? 
                                topic.attachments.map(att => `
                                    <div class="attachment-item">
                                        <div>
                                            <i class="fas fa-file me-2"></i>${att.filename}
                                            <small class="text-muted ms-2">(${formatFileSize(att.file_size)})</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="downloadAttachment('${att.id}')">
                                            <i class="fas fa-download me-1"></i>Download
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p class="text-muted">No attachments</p>'
                            }
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('viewTopicModal'));
                modal.show();
            } catch (error) {
                console.error('Error loading topic:', error);
                showError('Failed to load topic details');
            }
        }

        // Edit current topic (from view modal)
        function editCurrentTopic() {
            bootstrap.Modal.getInstance(document.getElementById('viewTopicModal')).hide();
            editTopic(currentTopicId);
        }

        // Display attachments in edit modal
        function displayAttachments(attachments) {
            const attachmentsList = document.getElementById('attachmentsList');
            
            if (attachments.length === 0) {
                attachmentsList.innerHTML = '<p class="text-muted">No attachments</p>';
                return;
            }
            
            attachmentsList.innerHTML = attachments.map(att => `
                <div class="attachment-item">
                    <div>
                        <i class="fas fa-file me-2"></i>${att.filename}
                        <small class="text-muted ms-2">(${formatFileSize(att.file_size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAttachment('${att.id}')">
                        <i class="fas fa-trash me-1"></i>Remove
                    </button>
                </div>
            `).join('');
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Save topic (create or update)
        async function saveTopic() {
            const form = document.getElementById('topicForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const formData = new FormData();
            formData.append('topic_name', document.getElementById('topicName').value);
            formData.append('type', document.getElementById('topicType').value);
            formData.append('area', document.getElementById('topicArea').value);
            formData.append('subject', document.getElementById('topicSubject').value);
            formData.append('content', document.getElementById('topicContent').value);

            const attachmentsInput = document.getElementById('topicAttachments');
            if (attachmentsInput.files.length > 0) {
                for (let file of attachmentsInput.files) {
                    formData.append('attachments', file);
                }
            }

            try {
                if (currentTopicId) {
                    // Update existing topic
                    await axios.patch(`${API_BASE}${currentTopicId}/`, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    showSuccess('Topic updated successfully');
                } else {
                    // Create new topic
                    await axios.post(API_BASE, formData, {
                        headers: { 'Content-Type': 'multipart/form-data' }
                    });
                    showSuccess('Topic created successfully');
                }

                // Close modal and refresh
                bootstrap.Modal.getInstance(document.getElementById('topicModal')).hide();
                loadTopics();
                loadStats();
            } catch (error) {
                console.error('Error saving topic:', error);
                showError('Failed to save topic');
            }
        }

        // Delete topic
        async function deleteTopic(topicId) {
            if (!confirm('Are you sure you want to delete this topic? This action cannot be undone.')) {
                return;
            }

            try {
                await axios.delete(`${API_BASE}${topicId}/`);
                showSuccess('Topic deleted successfully');
                loadTopics();
                loadStats();
            } catch (error) {
                console.error('Error deleting topic:', error);
                showError('Failed to delete topic');
            }
        }

        // Remove attachment
        async function removeAttachment(attachmentId) {
            if (!confirm('Are you sure you want to remove this attachment?')) {
                return;
            }

            try {
                await axios.delete(`${API_BASE}${currentTopicId}/remove_attachment/`, {
                    data: { attachment_id: attachmentId }
                });
                showSuccess('Attachment removed successfully');
                // Refresh the topic data
                editTopic(currentTopicId);
            } catch (error) {
                console.error('Error removing attachment:', error);
                showError('Failed to remove attachment');
            }
        }

        // Download attachment
        async function downloadAttachment(attachmentId) {
            try {
                const response = await axios.get(`${API_BASE}attachments/${attachmentId}/`, {
                    responseType: 'blob'
                });
                
                const url = window.URL.createObjectURL(new Blob([response.data]));
                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', response.headers['content-disposition']?.split('filename=')[1] || 'attachment');
                document.body.appendChild(link);
                link.click();
                link.remove();
            } catch (error) {
                console.error('Error downloading attachment:', error);
                showError('Failed to download attachment');
            }
        }

        // Utility functions
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('d-none');
            } else {
                spinner.classList.add('d-none');
            }
        }

        function showSuccess(message) {
            // You can implement a toast notification here
            alert(message);
        }

        function showError(message) {
            // You can implement a toast notification here
            alert('Error: ' + message);
        }
    </script>
</body>
</html>
